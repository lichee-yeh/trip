<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's Family Trip 2026</title>
    
    <!-- 1. æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- 2. Firebase è¨­å®š -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA1JHrkPbANS-g7X8OudpD0w819ZXA8-7A",
            authDomain: "family-trip-2026-1c43d.firebaseapp.com",
            projectId: "family-trip-2026-1c43d",
            storageBucket: "family-trip-2026-1c43d.firebasestorage.app",
            messagingSenderId: "157512457202",
            appId: "1:157512457202:web:b211df6298c0057e62e96b",
            measurementId: "G-LDQW10LQZ4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // æ›è¼‰åˆ° Window è®“ Vue ä½¿ç”¨
        window.db = db;
        window.fireOps = { collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs, writeBatch };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- 3. Tailwind è‡ªå®šç¾©ä¸»é¡Œ (æµ·æ´‹é¢¨) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ocean-bg': '#F0F9FF',        // æ·ºè—åº•è‰²
                        'card-white': '#FFFFFF',      // å¡ç‰‡ç™½
                        'teal-brand': '#0D9488',      // å“ç‰Œç¶  (Teal-600)
                        'teal-dark': '#115E59',       // æ·±ç¶  (æ–‡å­—)
                        'sunny-yellow': '#FCD34D',    // é™½å…‰é»ƒ (æŒ‰éˆ•)
                        'soft-gray': '#F1F5F9',       // æ·ºç°
                        'accent-blue': '#0EA5E9'      // é»ç¶´è—
                    }
                }
            }
        }
    </script>
    
    <!-- 4. CSS æ¨£å¼ (åƒè€ƒåŒ—æµ·é“ App) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Nunito:wght@700&display=swap');
        
        body {
            background-color: #F0F9FF; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #F8FAFC; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-bottom: 90px;
        }

        /* --- Header å€åŸŸ --- */
        .header-bg {
            background-color: #ffffff; 
            padding: 0; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.15); 
            border-bottom-left-radius: 35px; 
            border-bottom-right-radius: 35px;
            z-index: 10; 
            height: 260px;
        }
        
        .header-image-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æ¼¸å±¤é®ç½©ï¼Œè®“æ–‡å­—æ¸…æ¥š */
        .header-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4));
        }

        /* --- æ‡¸æµ®é ç±¤ (Tabs) --- */
        .side-tab-bar {
            position: absolute;
            bottom: 25px; 
            right: 20px;
            z-index: 30;
            display: flex;
            gap: 10px; 
        }
        
        .tab-button {
            width: 42px; 
            height: 42px;
            border-radius: 50%; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid white;
        }
        
        .tab-button.active {
            background-color: #0D9488; /* teal-brand */
            color: #ffffff;
            transform: scale(1.1) translateY(-5px);
        }
        
        .tab-button:not(.active) {
            background-color: #ffffff;
            color: #94A3B8; 
        }

        /* --- ä¸»å…§å®¹å€ --- */
        .app-main {
            padding-top: 20px; 
            position: relative;
            z-index: 5;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .card-shadow {
            box-shadow: 0 8px 20px -6px rgba(13, 148, 136, 0.1);
            transition: transform 0.2s ease;
        }
        .card-shadow:active { transform: scale(0.98); }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- æ—¥æœŸé¸å–®ç½®é ‚ --- */
        .date-selector-sticky {
            background-color: rgba(248, 250, 252, 0.95);
            backdrop-filter: blur(5px);
            position: sticky;
            top: 0;
            z-index: 20;
            padding-top: 10px;
            padding-bottom: 10px;
            margin-left: -16px;
            margin-right: -16px;
            padding-left: 16px;
            padding-right: 16px;
        }

        /* æ—¥æœŸå¡ç‰‡ */
        .date-card {
            width: 54px; height: 64px;
            border-radius: 16px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: all 0.2s;
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        .date-card.active {
            background-color: #0D9488;
            color: white;
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.3);
            transform: translateY(-2px);
        }
        .date-card.inactive {
            background-color: white;
            color: #94A3B8;
            border-color: white;
        }

        /* --- å‚™è¨»é–‹é—œ --- */
        .note-content {
            max-height: 2.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .note-content.expanded { max-height: 500px; }

        /* --- èŠ±è²»é  Banner --- */
        .expenses-banner {
            background: linear-gradient(135deg, #0F766E 0%, #14B8A6 100%);
            color: white;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        /* --- FAB æŒ‰éˆ• --- */
        .fab-btn {
            position: fixed; bottom: 24px; right: 24px;
            width: 56px; height: 56px;
            background-color: #FCD34D;
            color: #115E59;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(252, 211, 77, 0.5);
            z-index: 40;
            transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }

        /* èˆªç­å¡ç‰‡ */
        .flight-card {
            background: white;
            border-left: 4px solid #0EA5E9;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- Header å€åŸŸ -->
    <div class="header-bg">
        <div class="header-image-container">
            <!-- æ›¿æ›æˆå®¿éœ§æµ·æ´‹é¢¨æ ¼åœ–ç‰‡ -->
            <img src="https://images.unsplash.com/photo-1518509562904-e7ef99cdcc86?q=80&w=800&auto=format&fit=crop" alt="Cebu Ocean">
            <div class="header-overlay"></div>
            
            <div class="absolute top-8 left-6 text-white">
                <h1 class="text-2xl font-bold tracking-wide drop-shadow-md">Remi Family Trip</h1>
                <p class="text-sm opacity-90 font-light mt-1">6å¤§1å° â€¢ å®¿éœ§è–„è·å³¶ 8æ—¥éŠ</p>
            </div>
        </div>
        
        <!-- æ‡¸æµ® Tabs -->
        <div class="side-tab-bar">
            <button @click="currentTab = 'itinerary'" class="tab-button" :class="{'active': currentTab === 'itinerary'}">
                <i class="fa-solid fa-map-location-dot"></i>
            </button>
            <button @click="currentTab = 'info'" class="tab-button" :class="{'active': currentTab === 'info'}">
                <i class="fa-solid fa-circle-info"></i>
            </button>
            <button @click="currentTab = 'shopping'" class="tab-button" :class="{'active': currentTab === 'shopping'}">
                <i class="fa-solid fa-basket-shopping"></i>
            </button>
            <button @click="currentTab = 'expenses'" class="tab-button" :class="{'active': currentTab === 'expenses'}">
                <i class="fa-solid fa-coins"></i>
            </button>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="p-4 app-main">
        
        <!-- 1. è¡Œç¨‹è¡¨ Tab -->
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in pb-20">
            
            <!-- Sticky Date Selector -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 date-selector-sticky">
                <div v-for="(day, index) in tripDays" :key="index" 
                     @click="changeDate(index)"
                     class="date-card snap-center"
                     :class="currentDateIndex === index ? 'active' : 'inactive'">
                    <span class="text-xs font-bold uppercase">{{ day.dayShort }}</span> 
                    <span class="text-lg font-bold font-mono">{{ day.dayNum }}</span> 
                </div>
            </div>

            <!-- Weather Widget -->
            <div class="mb-5 bg-white border border-teal-100 rounded-2xl p-4 flex justify-between items-center shadow-sm">
                <div class="flex items-center text-teal-dark space-x-4">
                    <i :class="currentWeather.icon" class="text-4xl text-amber-400"></i>
                    <div>
                        <div class="flex items-end">
                            <span class="text-3xl font-bold leading-none font-mono">{{ currentWeather.temp }}Â°</span>
                            <span class="text-xs text-slate-400 ml-1 mb-1">Cebu</span>
                        </div>
                        <span class="block text-xs text-slate-500 mt-0.5">é«”æ„Ÿ {{ currentWeather.feels_like }}Â° â€¢ {{ currentWeather.desc }}</span> 
                    </div>
                </div>
                <div class="text-right">
                    <span class="inline-block px-2 py-1 bg-teal-50 text-teal-600 text-[10px] font-bold rounded-lg border border-teal-100">
                        Day {{ currentDateIndex + 1 }}
                    </span>
                </div>
            </div>

            <!-- Loading State -->
            <div v-if="!firebaseReady || currentDayEvents.length === 0" class="text-center py-16 text-slate-300">
                <i class="fa-solid fa-umbrella-beach text-5xl mb-3 text-slate-200"></i>
                <p class="text-sm">è¼‰å…¥è¡Œç¨‹ä¸­...</p>
                <button @click="forceInit" class="mt-4 text-xs text-teal-600 border border-teal-200 px-3 py-1 rounded-full">é‡æ–°æ•´ç†</button>
            </div>

            <!-- Timeline Events -->
            <div class="space-y-4">
                <div v-for="(item, idx) in currentDayEvents" :key="item.id" class="relative group">
                    
                    <!-- Transport Line -->
                    <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-slate-400">
                        <div class="h-6 w-0.5 bg-slate-200 absolute left-6 -top-3"></div>
                        <i class="fa-solid fa-caret-down mr-2 text-slate-300"></i>
                        <span>ç´„ 15 åˆ†é˜</span>
                    </div>
                    
                    <!-- Card -->
                    <div class="bg-white rounded-3xl p-4 card-shadow relative overflow-hidden flex items-start border border-slate-50 active:scale-95 transition-transform"
                         @click="openMap(item.locationName || item.title)">
                        
                        <!-- Time & Icon Column -->
                        <div class="mr-4 flex flex-col items-center min-w-[50px]">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-sm mb-1" 
                                 :class="getCategoryColor(item.type)">
                                <i :class="getCategoryIcon(item.type)"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-600 font-mono">{{ item.time }}</span>
                        </div>

                        <!-- Info Column -->
                        <div class="flex-1 pb-1 min-w-0">
                            <h3 class="text-base font-bold text-slate-800 mb-1 leading-tight truncate pr-6">{{ item.title }}</h3>
                            
                            <div class="text-xs text-slate-500 space-y-1 mt-1">
                                <p v-if="item.locationName" class="flex items-center truncate">
                                    <i class="fa-solid fa-location-dot w-4 text-center mr-1 text-teal-400"></i> {{ item.locationName }}
                                </p>
                                <p v-if="item.tag" class="flex items-center">
                                    <i class="fa-solid fa-tag w-4 text-center mr-1 text-teal-400"></i> {{ item.tag }}
                                </p>
                            </div>

                            <!-- Note (Collapsible) -->
                            <div v-if="item.note" class="mt-2 text-[11px] bg-slate-50 p-2 rounded-lg border border-slate-100 text-slate-500">
                                {{ item.note }}
                            </div>
                        </div>

                        <!-- Action Icons (Top Right) -->
                        <div class="absolute top-3 right-3 text-slate-300">
                            <i class="fa-solid fa-chevron-right text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. è³‡è¨Š Tab -->
        <div v-if="currentTab === 'info'" class="animate-fade-in space-y-5 pb-20">
            
            <!-- Exchange Rate -->
            <div class="bg-gradient-to-r from-teal-600 to-emerald-500 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <h3 class="font-bold text-lg mb-4 flex items-center relative z-10"><i class="fa-solid fa-calculator mr-2"></i> åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center justify-between space-x-3 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-teal-100 block mb-1 uppercase">PHP (æŠ«ç´¢)</label>
                        <input type="number" v-model="calcPHP" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2 text-white font-mono font-bold text-xl outline-none" placeholder="â‚±">
                    </div>
                    <i class="fa-solid fa-arrow-right text-white/50 mt-5"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-teal-100 block mb-1 uppercase">TWD (å°å¹£)</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2 text-white font-mono font-bold text-xl">
                            $ {{ (calcPHP * 0.56).toFixed(0) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flights -->
            <div class="bg-white rounded-3xl p-5 card-shadow">
                <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2"><i class="fa-solid fa-plane text-blue-500 mr-2"></i> èˆªç­è³‡è¨Š</h3>
                
                <div class="flight-card">
                    <div class="flex justify-between text-sm font-bold text-sky-700 mb-1"><span>å»ç¨‹ (2/11)</span> <span class="text-xs bg-sky-100 px-2 rounded-full">è½‰æ©Ÿ</span></div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-center">
                            <div class="text-xl font-black">TPE</div>
                            <div class="text-xs text-slate-400">03:15</div>
                        </div>
                        <i class="fa-solid fa-plane text-sky-300"></i>
                        <div class="text-center">
                            <div class="text-xl font-black">CEB</div>
                            <div class="text-xs text-slate-400">12:25</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 text-center mt-2 border-t border-sky-50 pt-1">å®¿éœ§å¤ªå¹³æ´‹ 5J311 / 5J585</div>
                </div>

                <div class="flight-card border-orange-400">
                    <div class="flex justify-between text-sm font-bold text-orange-700 mb-1"><span>å›ç¨‹ (2/18)</span> <span class="text-xs bg-orange-100 px-2 rounded-full">ç›´é£›</span></div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-center">
                            <div class="text-xl font-black">MNL</div>
                            <div class="text-xs text-slate-400">23:35</div>
                        </div>
                        <i class="fa-solid fa-plane text-orange-300"></i>
                        <div class="text-center">
                            <div class="text-xl font-black">TPE</div>
                            <div class="text-xs text-slate-400">02:00+1</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 text-center mt-2 border-t border-orange-50 pt-1">å®¿éœ§å¤ªå¹³æ´‹ 5J310 (T3)</div>
                </div>
            </div>

            <!-- Hotels -->
            <div class="bg-white rounded-3xl p-5 card-shadow">
                <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2"><i class="fa-solid fa-bed text-indigo-500 mr-2"></i> ä½å®¿æ¸…å–®</h3>
                <ul class="space-y-4">
                    <li v-for="h in hotels" class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-slate-700 text-sm">{{ h.name }}</div>
                            <div class="text-xs text-slate-400 mt-0.5">{{ h.area }}</div>
                        </div>
                        <a :href="'https://www.google.com/maps/search/?api=1&query=' + h.name" target="_blank" class="text-teal-500 bg-teal-50 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-location-arrow text-xs"></i></a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 3. è³¼ç‰© Tab -->
        <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-20">
            <h2 class="text-lg font-bold text-slate-800 px-2 mb-3">è³¼ç‰©æ¸…å–®</h2>
            <div class="grid grid-cols-2 gap-3">
                <div v-for="item in shoppingList" :key="item.id" class="bg-white rounded-2xl p-3 card-shadow relative">
                    <button @click="deleteItem('shopping_v4', item.id)" class="absolute top-2 right-2 text-slate-300 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                    <div class="aspect-square bg-slate-50 rounded-xl mb-2 overflow-hidden flex items-center justify-center">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <i v-else class="fa-solid fa-image text-slate-200 text-2xl"></i>
                    </div>
                    <div class="font-bold text-slate-700 text-sm truncate">{{ item.name }}</div>
                </div>
            </div>
            
            <div v-if="shoppingList.length === 0" class="text-center py-20 text-slate-300">
                <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                <p class="text-xs">å°šç„¡æ¸…å–®</p>
            </div>
        </div>

        <!-- 4. èŠ±è²» Tab -->
        <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20">
            <div class="expenses-banner p-6 shadow-lg mb-5">
                <p class="text-xs text-teal-100 mb-1">ç›®å‰ç¸½èŠ±è²» (PHP)</p>
                <h2 class="text-4xl font-bold font-mono tracking-tight">â‚± {{ formatNumber(totalExpense) }}</h2>
                <p class="text-xs text-right mt-2 opacity-80 border-t border-white/20 pt-2">ç´„ NT$ {{ formatNumber(totalExpense * 0.56) }}</p>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[400px] p-6 shadow-inner -mx-4 px-6">
                <h3 class="font-bold text-slate-800 mb-4 text-sm">æ”¯å‡ºç´€éŒ„</h3>
                <div class="space-y-4">
                    <div v-for="ex in expenseList" :key="ex.id" class="flex items-center justify-between border-b border-slate-50 pb-3 last:border-0">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white mr-3 shadow-sm text-sm" 
                                 :class="getCategoryColor(ex.category)">
                                <i :class="getExpenseIcon(ex.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-slate-700 text-sm">{{ ex.name }}</div>
                                <div class="text-[10px] text-slate-400">{{ ex.date }} â€¢ {{ ex.payment === 'card' ? 'ğŸ’³' : 'ğŸ’µ' }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-slate-700 font-mono">â‚±{{ formatNumber(ex.amount) }}</div>
                            <button @click="deleteItem('expenses_v4', ex.id)" class="text-[10px] text-red-300">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- FAB æŒ‰éˆ• (æ–°å¢) -->
    <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fab-btn">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Modals (Event, Shopping, Expense) - ä¿ç•™åŠŸèƒ½ä½†éš±è—ä»£ç¢¼ä»¥ç¯€çœç¯‡å¹…ï¼Œé‚è¼¯åŒå‰ä¸€ç‰ˆ -->
    <div v-if="showModal" class="fixed inset-0 bg-teal-900/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center text-slate-800">{{ modalTitle }}</h3>
            
            <!-- Dynamic Form Content based on Tab -->
            <div v-if="currentTab === 'shopping'" class="space-y-4">
                <input v-model="newItem.name" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none" placeholder="å•†å“åç¨±">
                <div class="border-2 border-dashed border-slate-200 rounded-xl h-32 flex items-center justify-center relative cursor-pointer" @click="$refs.fileInput.click()">
                    <span v-if="!newItem.image" class="text-xs text-slate-400"><i class="fa-solid fa-camera mr-1"></i> ä¸Šå‚³ç…§ç‰‡</span>
                    <img v-else :src="newItem.image" class="w-full h-full object-cover rounded-xl opacity-80">
                    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleImageUpload">
                </div>
            </div>

            <div v-if="currentTab === 'expenses'" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" v-model="newItem.date" class="bg-slate-50 rounded-xl p-3 text-sm">
                    <select v-model="newItem.category" class="bg-slate-50 rounded-xl p-3 text-sm">
                        <option value="food">é£²é£Ÿ</option><option value="transport">äº¤é€š</option><option value="shop">è³¼ç‰©</option><option value="hotel">ä½å®¿</option>
                    </select>
                </div>
                <input v-model="newItem.name" class="w-full bg-slate-50 rounded-xl p-3 text-sm" placeholder="é …ç›®åç¨±">
                <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-400 font-bold">â‚±</span>
                    <input type="number" v-model.number="newItem.amount" class="w-full bg-slate-50 rounded-xl p-3 pl-7 text-sm font-bold" placeholder="é‡‘é¡">
                </div>
            </div>

            <div class="flex space-x-3 mt-6">
                <button @click="showModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                <button @click="saveItem" class="flex-1 py-3 rounded-xl bg-sunny-yellow text-teal-900 font-bold text-sm shadow-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- State ---
            const currentTab = ref('itinerary');
            const currentDateIndex = ref(0);
            const calcPHP = ref('');
            const showModal = ref(false);
            const modalTitle = ref('');
            const newItem = ref({});
            const firebaseReady = ref(false);

            // Data
            const tripDays = [
                { date: '2026-02-11', dayShort: 'é€±ä¸‰', dayNum: '11' },
                { date: '2026-02-12', dayShort: 'é€±å››', dayNum: '12' },
                { date: '2026-02-13', dayShort: 'é€±äº”', dayNum: '13' },
                { date: '2026-02-14', dayShort: 'é€±å…­', dayNum: '14' },
                { date: '2026-02-15', dayShort: 'é€±æ—¥', dayNum: '15' },
                { date: '2026-02-16', dayShort: 'é€±ä¸€', dayNum: '16' },
                { date: '2026-02-17', dayShort: 'é€±äºŒ', dayNum: '17' },
                { date: '2026-02-18', dayShort: 'é€±ä¸‰', dayNum: '18' }
            ];

            const hotels = [
                { name: 'å®¿å‹™æ´¾å…‹è˜­åœ‹éš›å¤§é£¯åº—', area: 'å®¿éœ§å¸‚å€' },
                { name: 'Best Western Plus', area: 'é‚¦å‹ Alona' },
                { name: 'Villa Kalachuchi', area: 'é‚¦å‹ Danao' },
                { name: 'Uptown Parksuites', area: 'é¦¬å°¼æ‹‰ BGC' }
            ];

            // Reactive Lists (Connected to Firebase)
            const events = ref([]);
            const expenseList = ref([]);
            const shoppingList = ref([]);

            // --- Firebase Listeners ---
            onMounted(() => {
                window.addEventListener('firebase-ready', () => {
                    firebaseReady.value = true;
                    const { collection, onSnapshot, query, orderBy } = window.fireOps;
                    const db = window.db;

                    // ç¶å®šä¸‰å€‹è³‡æ–™æµ (v4_fixed æ˜¯ä¹‹å‰ä¿®å¾©å¥½çš„è³‡æ–™)
                    onSnapshot(query(collection(db, 'remi_trip_2026_final_map_fix')), (snap) => {
                        events.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    onSnapshot(query(collection(db, 'expenses_v4'), orderBy('date', 'desc')), (snap) => {
                        expenseList.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    onSnapshot(query(collection(db, 'shopping_v4')), (snap) => {
                        shoppingList.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                });
            });

            // --- Computed ---
            const currentDayEvents = computed(() => {
                const targetDate = tripDays[currentDateIndex.value].date;
                return events.value
                    .filter(e => e.date === targetDate)
                    .sort((a,b) => a.time.localeCompare(b.time));
            });

            const totalExpense = computed(() => expenseList.value.reduce((sum, item) => sum + Number(item.amount || 0), 0));
            
            const currentWeather = computed(() => {
                // Mock weather based on index
                const weathers = [
                    { temp: 30, feels_like: 34, desc: 'æ™´æ™‚å¤šé›²', icon: 'fa-solid fa-sun' },
                    { temp: 29, feels_like: 33, desc: 'åˆå¾Œé›·é™£é›¨', icon: 'fa-solid fa-cloud-sun-rain' },
                    { temp: 28, feels_like: 31, desc: 'å¤šé›²èˆ’é©', icon: 'fa-solid fa-cloud' }
                ];
                return weathers[currentDateIndex.value % 3];
            });

            // --- Methods ---
            const changeDate = (idx) => currentDateIndex.value = idx;
            
            const openMap = (query) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
            };

            const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';

            const handleAddClick = () => {
                newItem.value = {};
                if(currentTab.value === 'shopping') {
                    modalTitle.value = 'æ–°å¢è³¼ç‰©æ¸…å–®';
                    showModal.value = true;
                } else if(currentTab.value === 'expenses') {
                    modalTitle.value = 'æ–°å¢èŠ±è²»';
                    newItem.value = { date: tripDays[currentDateIndex.value].date, payment: 'cash', category: 'food' };
                    showModal.value = true;
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => newItem.value.image = e.target.result;
                    reader.readAsDataURL(file);
                }
            };

            const saveItem = async () => {
                const { addDoc, collection } = window.fireOps;
                const db = window.db;
                if(currentTab.value === 'shopping') {
                    await addDoc(collection(db, 'shopping_v4'), newItem.value);
                } else if(currentTab.value === 'expenses') {
                    await addDoc(collection(db, 'expenses_v4'), newItem.value);
                }
                showModal.value = false;
            };

            const deleteItem = async (col, id) => {
                if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await window.fireOps.deleteDoc(window.fireOps.doc(window.db, col, id));
            };
            
            const forceInit = () => window.location.reload();

            // Helpers
            const getCategoryIcon = (c) => ({ spot: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', hotel: 'fa-solid fa-bed', transport: 'fa-solid fa-car', note: 'fa-solid fa-note-sticky' })[c] || 'fa-solid fa-circle';
            const getCategoryColor = (c) => ({ spot: 'bg-cyan-500', food: 'bg-orange-400', hotel: 'bg-indigo-500', transport: 'bg-blue-500', note: 'bg-rose-400' })[c] || 'bg-slate-400';
            const getExpenseIcon = (c) => ({ food: 'fa-solid fa-utensils', transport: 'fa-solid fa-car', shop: 'fa-solid fa-bag-shopping', hotel: 'fa-solid fa-bed' })[c] || 'fa-solid fa-coins';

            return {
                currentTab, tripDays, currentDateIndex, currentDayEvents, expenseList, shoppingList,
                changeDate, formatNumber, calcPHP, totalExpense, currentWeather, hotels,
                showModal, modalTitle, newItem, handleAddClick, handleImageUpload, saveItem, deleteItem,
                openMap, forceInit, firebaseReady,
                getCategoryIcon, getCategoryColor, getExpenseIcon
            };
        }
    }).mount('#app');
</script>
</body>
</html>
