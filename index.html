<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's 2026 Trip</title>
    
    <!-- Ê†∏ÂøÉÂ∫´ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Nunito:wght@700;900&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA1JHrkPbANS-g7X8OudpD0w819ZXA8-7A",
            authDomain: "family-trip-2026-1c43d.firebaseapp.com",
            projectId: "family-trip-2026-1c43d",
            storageBucket: "family-trip-2026-1c43d.firebasestorage.app",
            messagingSenderId: "157512457202",
            appId: "1:157512457202:web:b211df6298c0057e62e96b",
            measurementId: "G-LDQW10LQZ4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fireOps = { collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs, writeBatch };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#2563EB', // Blue-600
                        secondary: '#FCD34D', // Amber-300 (Yellow button)
                        bg: '#F3F4F6', // Gray-100
                    },
                    fontFamily: { 
                        sans: ['Noto Sans TC', 'sans-serif'],
                        en: ['Nunito', 'sans-serif']
                    },
                    boxShadow: {
                        'float': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Êó•ÊúüÈÅ∏ÂñÆÊ®£Âºè */
        .date-btn-active { background-color: #1E40AF; color: white; transform: scale(1.05); box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3); }
        .date-btn-inactive { background-color: white; color: #9CA3AF; }
        
        /* Ëà™Áè≠Âç°Áâá */
        .boarding-pass {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            position: relative;
            mask-image: radial-gradient(circle at 0 50%, transparent 8px, black 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, black 8.5px);
            -webkit-mask-image: radial-gradient(circle at 0 50%, transparent 8px, black 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, black 8.5px);
            mask-composite: source-in; 
        }
        
        /* ÊãñÊõ≥Ê®£Âºè */
        .draggable-item { touch-action: none; transition: transform 0.2s, box-shadow 0.2s; }
        .dragging { opacity: 0.5; transform: scale(0.98); z-index: 50; }
        
        /* ËÉåÊôØÊèíÁï´Ê®°Êì¨ */
        .header-bg {
            background: linear-gradient(180deg, #DBEAFE 0%, #F3F4F6 100%);
            position: relative;
            overflow: hidden;
        }
        .cloud { position: absolute; background: white; border-radius: 50%; opacity: 0.6; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans text-slate-700 overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto bg-slate-50 relative shadow-2xl">

        <!-- 1. Ë°åÁ®ãË°® (Schedule) -->
        <div v-if="currentTab === 'schedule'" class="flex flex-col h-full">
            
            <!-- Header Area -->
            <div class="header-bg pt-6 pb-2 px-4 rounded-b-[2rem] shadow-sm z-10 shrink-0">
                <!-- Top Bar -->
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <div class="bg-blue-600 text-white p-1.5 rounded-full"><i data-lucide="map" class="w-4 h-4"></i></div>
                        <div>
                            <h1 class="text-lg font-black text-slate-800 leading-none">Remi Family Trip</h1>
                            <span class="text-[10px] text-slate-500 font-en">Cebu & Bohol 2026</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="currentTab='info'" class="w-8 h-8 rounded-full bg-white/80 flex items-center justify-center shadow-sm text-blue-600"><i data-lucide="info" class="w-4 h-4"></i></button>
                        <button @click="currentTab='shopping'" class="w-8 h-8 rounded-full bg-white/80 flex items-center justify-center shadow-sm text-blue-600"><i data-lucide="shopping-basket" class="w-4 h-4"></i></button>
                        <button @click="currentTab='expenses'" class="w-8 h-8 rounded-full bg-white/80 flex items-center justify-center shadow-sm text-blue-600"><i data-lucide="coins" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <!-- Date Scroller -->
                <div class="flex overflow-x-auto hide-scrollbar gap-3 py-2 snap-x px-1">
                    <button v-for="(day, idx) in tripDays" :key="idx" @click="changeDate(idx)"
                        class="flex-shrink-0 flex flex-col items-center justify-center w-[3.5rem] h-16 rounded-2xl transition-all duration-200 snap-start border border-transparent"
                        :class="currentDateIndex === idx ? 'date-btn-active' : 'date-btn-inactive'">
                        <span class="text-sm font-black font-en">{{ day.dayShort }}</span>
                        <span class="text-xs font-bold font-en">{{ day.dateShort.split('/')[1] }}</span>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-4 pt-4 pb-24 hide-scrollbar space-y-4">
                
                <!-- Weather Widget -->
                <div class="bg-white rounded-3xl p-4 shadow-card flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i :data-lucide="currentWeather.icon" class="w-10 h-10 text-blue-500"></i>
                        <div>
                            <div class="flex items-end gap-1">
                                <span class="text-3xl font-black text-slate-800 font-en">{{ currentWeather.temp }}¬∞</span>
                                <span class="text-xs text-slate-400 mb-1">/ È´îÊÑü {{ currentWeather.feels_like }}¬∞</span>
                            </div>
                            <div class="text-xs text-slate-500">{{ currentCity }} ‚Ä¢ {{ currentWeather.desc }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-bold mb-1">Êú¨Êó•ÈáçÈªû</div>
                        <div class="text-xs font-bold text-slate-700">{{ tripDays[currentDateIndex].highlight }}</div>
                    </div>
                </div>

                <!-- Timeline Items -->
                <div class="space-y-0 relative">
                    <!-- Empty State -->
                    <div v-if="currentDayEvents.length === 0" class="text-center py-10 text-slate-400">
                        <p class="text-sm">Â∞öÊú™ÂÆâÊéíË°åÁ®ã</p>
                        <button @click="forceInit" class="text-xs text-blue-500 underline mt-2">ËºâÂÖ•È†êË®≠Ë°åÁ®ã</button>
                    </div>

                    <div v-for="(event, index) in currentDayEvents" :key="event.id"
                         class="draggable-item relative pl-4 pb-0"
                         :draggable="true"
                         @dragstart="dragStart(index, $event)"
                         @dragover.prevent
                         @drop="dragDrop(index)">
                        
                        <!-- Transport Line (Connector) -->
                        <div v-if="index > 0" class="absolute left-[23px] -top-6 h-10 w-0.5 bg-slate-200 z-0"></div>
                        <div v-if="index > 0" class="absolute left-8 -top-5 flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded text-[10px] text-slate-500 z-10 border border-white">
                            <i :data-lucide="getTransportIcon(event.transportMode)" class="w-3 h-3"></i>
                            <span>{{ event.transportTime || 'ÁßªÂãï' }}</span>
                        </div>

                        <!-- Card -->
                        <div @click="openMap(event)" class="group relative z-10 mb-6 active:scale-95 transition-transform">
                            
                            <!-- Flight Card Style -->
                            <div v-if="event.category === 'flight'" class="boarding-pass rounded-2xl p-5 shadow-lg shadow-blue-200">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="text-left">
                                        <div class="text-xs opacity-70">DEPART</div>
                                        <div class="text-2xl font-black font-en">{{ event.depCode || 'TPE' }}</div>
                                        <div class="text-sm font-bold">{{ event.time }}</div>
                                    </div>
                                    <div class="flex flex-col items-center flex-1 px-4">
                                        <i data-lucide="plane" class="w-6 h-6 rotate-90 opacity-80"></i>
                                        <div class="w-full h-0.5 bg-white/30 my-1"></div>
                                        <span class="text-[10px] font-mono">{{ event.flightNum }}</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs opacity-70">ARRIVE</div>
                                        <div class="text-2xl font-black font-en">{{ event.arrCode || 'CEB' }}</div>
                                        <div class="text-sm font-bold">{{ event.endTime || '--:--' }}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t border-white/20">
                                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm">‚úàÔ∏è Ëà™Áè≠Ë≥áË®ä</span>
                                    <button @click.stop="editEvent(event)" class="text-white/80 hover:text-white"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                                </div>
                            </div>

                            <!-- Normal Card Style -->
                            <div v-else class="bg-white rounded-2xl p-4 shadow-card border border-slate-100 flex gap-4">
                                <!-- Time & Icon -->
                                <div class="flex flex-col items-center w-12 shrink-0">
                                    <div class="text-sm font-black text-slate-800 font-en">{{ event.time }}</div>
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center mt-2 text-white shadow-sm"
                                         :class="getCategoryColor(event.category)">
                                        <i :data-lucide="getCategoryIcon(event.category)" class="w-4 h-4"></i>
                                    </div>
                                </div>

                                <!-- Details -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-bold text-slate-800 text-base leading-tight truncate pr-2">{{ event.title }}</h3>
                                        <button @click.stop="editEvent(event)" class="text-slate-300 hover:text-blue-500 p-1"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                                    </div>
                                    
                                    <!-- Info Tags Row -->
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span v-if="event.hours" class="text-[10px] bg-slate-50 border border-slate-200 px-2 py-0.5 rounded text-slate-500 flex items-center">
                                            <i data-lucide="clock" class="w-3 h-3 mr-1"></i> {{ event.hours }}
                                        </span>
                                        <span v-if="event.ticket" class="text-[10px] bg-yellow-50 border border-yellow-200 px-2 py-0.5 rounded text-yellow-700 flex items-center">
                                            <i data-lucide="ticket" class="w-3 h-3 mr-1"></i> {{ event.ticket }}
                                        </span>
                                    </div>

                                    <!-- Location / Note -->
                                    <p v-if="event.locationName" class="text-xs text-slate-400 mt-2 flex items-center truncate">
                                        <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> {{ event.locationName }}
                                    </p>
                                    <p v-if="event.note" class="text-xs text-slate-500 mt-2 bg-slate-50 p-2 rounded-lg border border-slate-100 leading-relaxed">
                                        {{ event.note }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Action Button (Add) -->
            <button @click="openAddModal" class="absolute bottom-6 right-6 w-14 h-14 bg-yellow-400 rounded-full shadow-xl shadow-yellow-200/50 text-yellow-900 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-30">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- 2. Ë≥áË®äÈ†Å (Info) -->
        <div v-if="currentTab === 'info'" class="flex flex-col h-full bg-slate-100 p-4 pb-20 overflow-y-auto">
            <h2 class="text-xl font-black text-slate-800 mb-4 px-2 mt-4">ÊóÖÈÅäË≥áË®ä</h2>
            
            <!-- Exchange Rate -->
            <div class="bg-blue-600 rounded-2xl p-5 text-white shadow-lg mb-4">
                <h3 class="text-sm font-bold opacity-80 mb-3 flex items-center"><i data-lucide="coins" class="w-4 h-4 mr-2"></i> ÂåØÁéáÊèõÁÆó (‰ªäÊó•)</h3>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] opacity-70 block mb-1">PHP Êä´Á¥¢</label>
                        <input type="number" v-model="calcPHP" class="w-full bg-white/20 border-0 rounded-xl text-2xl font-mono font-bold p-2 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                    </div>
                    <i data-lucide="arrow-right" class="w-5 h-5 text-white/50"></i>
                    <div class="flex-1">
                        <label class="text-[10px] opacity-70 block mb-1">TWD Âè∞Âπ£</label>
                        <div class="text-2xl font-mono font-bold p-2">{{ (calcPHP * 0.56).toFixed(0) }}</div>
                    </div>
                </div>
            </div>

            <!-- Flights (Design from PDF) -->
            <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="plane" class="w-4 h-4 mr-2 text-blue-500"></i> Ëà™Áè≠Ë≥áË®ä</h3>
                
                <!-- Outbound -->
                <div class="border-l-4 border-blue-500 pl-4 py-1 mb-6">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">ÂéªÁ®ã 2/11</span>
                        <span class="text-xs font-mono text-slate-400">5J311 / 5J585</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div>
                            <div class="text-2xl font-black font-en">TPE</div>
                            <div class="text-xs text-slate-500">03:15</div>
                        </div>
                        <div class="flex flex-col items-center px-2">
                            <span class="text-[10px] text-slate-400">È¶¨Â∞ºÊãâËΩâÊ©ü</span>
                            <div class="w-16 h-0.5 bg-slate-200 relative">
                                <div class="absolute -right-1 -top-1 w-2 h-2 rounded-full bg-slate-300"></div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black font-en">CEB</div>
                            <div class="text-xs text-slate-500">12:25</div>
                        </div>
                    </div>
                </div>

                <!-- Inbound -->
                <div class="border-l-4 border-orange-500 pl-4 py-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-0.5 rounded">ÂõûÁ®ã 2/18</span>
                        <span class="text-xs font-mono text-slate-400">5J310</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div>
                            <div class="text-2xl font-black font-en">MNL</div>
                            <div class="text-xs text-slate-500">23:35</div>
                        </div>
                        <div class="flex flex-col items-center px-2">
                            <span class="text-[10px] text-slate-400">Áõ¥È£õ</span>
                            <div class="w-16 h-0.5 bg-slate-200 relative"></div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black font-en">TPE</div>
                            <div class="text-xs text-slate-500">02:00 <span class="text-[9px] text-red-400">+1</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency -->
            <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="siren" class="w-4 h-4 mr-2 text-red-500"></i> Á∑äÊÄ•Ê±ÇÂä©</h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="tel:117" class="bg-red-50 p-4 rounded-xl text-center active:scale-95 transition">
                        <div class="text-xs text-red-400 mb-1">Ë≠¶ÂØü</div>
                        <div class="text-2xl font-black text-red-600 font-en">117</div>
                    </a>
                    <a href="tel:168" class="bg-red-50 p-4 rounded-xl text-center active:scale-95 transition">
                        <div class="text-xs text-red-400 mb-1">ÊïëË≠∑Ëªä</div>
                        <div class="text-2xl font-black text-red-600 font-en">168</div>
                    </a>
                </div>
            </div>
        </div>

        <!-- 3. Ë≥ºÁâ©Ê∏ÖÂñÆ (Shopping) -->
        <div v-if="currentTab === 'shopping'" class="flex flex-col h-full bg-white p-4 pb-20 overflow-y-auto">
            <h2 class="text-xl font-black text-slate-800 mb-4 px-2 mt-4">Ë≥ºÁâ©Ê∏ÖÂñÆ</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div v-for="item in shoppingList" :key="item.id" class="group relative bg-slate-50 rounded-2xl p-3 border border-slate-100 shadow-sm hover:shadow-md transition">
                    <button @click="deleteItem('shopping', item.id)" class="absolute top-2 right-2 w-6 h-6 bg-white/90 rounded-full flex items-center justify-center text-slate-400 hover:text-red-500 shadow-sm z-10"><i data-lucide="x" class="w-3 h-3"></i></button>
                    
                    <div class="aspect-square bg-white rounded-xl mb-3 overflow-hidden flex items-center justify-center border border-slate-100">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <i v-else data-lucide="image" class="w-8 h-8 text-slate-200"></i>
                    </div>
                    <div class="px-1">
                        <h4 class="font-bold text-slate-700 text-sm truncate">{{ item.name }}</h4>
                        <div class="flex items-center gap-1.5 mt-1.5 cursor-pointer" @click="toggleShopCheck(item)">
                            <div class="w-4 h-4 rounded border flex items-center justify-center" :class="item.checked ? 'bg-green-500 border-green-500' : 'border-slate-300 bg-white'">
                                <i v-if="item.checked" data-lucide="check" class="w-3 h-3 text-white"></i>
                            </div>
                            <span class="text-xs" :class="item.checked ? 'text-green-600 line-through' : 'text-slate-400'">{{ item.checked ? 'Â∑≤Ë≥ºË≤∑' : 'ÂæÖË≤∑' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAB -->
            <button @click="showShoppingModal=true" class="absolute bottom-24 right-5 w-14 h-14 bg-yellow-400 rounded-full shadow-lg shadow-yellow-200/50 text-yellow-900 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-30">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- 4. Ëä±Ë≤ª (Expenses) -->
        <div v-if="currentTab === 'expenses'" class="flex flex-col h-full bg-slate-50 p-4 pb-20 overflow-y-auto">
            <h2 class="text-xl font-black text-slate-800 mb-4 px-2 mt-4">ÊóÖË≤ªË®òÈåÑ</h2>
            
            <!-- Total Card -->
            <div class="bg-slate-800 rounded-3xl p-6 text-white shadow-xl shadow-slate-300 mb-6 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-slate-400 uppercase tracking-widest">Total Expenses</span>
                        <i data-lucide="wallet" class="w-4 h-4 text-slate-400"></i>
                    </div>
                    <div class="text-4xl font-mono font-bold">‚Ç± {{ totalExpense.toLocaleString() }}</div>
                    <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-center">
                        <span class="text-xs text-slate-400">Âè∞Âπ£Á¥Ñ</span>
                        <span class="text-sm font-bold font-mono">NT$ {{ (totalExpense * 0.56).toLocaleString() }}</span>
                    </div>
                </div>
                <!-- Decorative Circles -->
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-blue-500 rounded-full opacity-20 blur-2xl"></div>
                <div class="absolute -left-6 -bottom-6 w-24 h-24 bg-yellow-500 rounded-full opacity-10 blur-xl"></div>
            </div>

            <!-- List -->
            <div class="space-y-3">
                <div v-for="ex in expenseList" :key="ex.id" class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg" :class="getExpenseColor(ex.category)">
                            <i :data-lucide="getExpenseIcon(ex.category)" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-sm">{{ ex.name }}</div>
                            <div class="text-[10px] text-slate-400 mt-0.5 flex items-center gap-1">
                                <span>{{ ex.date }}</span> ‚Ä¢ <span>{{ ex.payment === 'card' ? 'üí≥ Âà∑Âç°' : 'üíµ ÁèæÈáë' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold font-mono text-slate-700">‚Ç±{{ ex.amount }}</div>
                        <button @click="deleteItem('expenses', ex.id)" class="text-[10px] text-red-300 hover:text-red-500 mt-1">Âà™Èô§</button>
                    </div>
                </div>
            </div>

            <!-- FAB -->
            <button @click="showExpenseModal=true" class="absolute bottom-24 right-5 w-14 h-14 bg-yellow-400 rounded-full shadow-lg shadow-yellow-200/50 text-yellow-900 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-30">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- 5. Bottom Navigation -->
        <nav class="fixed bottom-6 left-4 right-4 bg-white/90 backdrop-blur-md h-16 rounded-full shadow-float flex justify-around items-center px-2 z-40 border border-white/50">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                class="relative w-12 h-12 flex items-center justify-center rounded-full transition-all duration-300"
                :class="currentTab === tab.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 -translate-y-2' : 'text-slate-400 hover:bg-slate-50'">
                <i :data-lucide="tab.icon" class="w-5 h-5"></i>
            </button>
        </nav>

        <!-- === Modals === -->

        <!-- Event Modal -->
        <div v-if="showEventModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-slate-800">{{ isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                    <button v-if="isEditing" @click="deleteEvent" class="text-red-500 bg-red-50 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> Âà™Èô§</button>
                </div>
                <div class="space-y-4">
                    <!-- Category -->
                    <div>
                        <label class="label">ÂàÜÈ°û</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button v-for="cat in ['spot','food','shop','hotel','flight','other']" :key="cat"
                                @click="formEvent.category = cat"
                                class="py-2 rounded-xl text-xs font-bold border transition-all flex items-center justify-center gap-1"
                                :class="formEvent.category === cat ? 'bg-blue-50 border-blue-500 text-blue-600' : 'border-slate-200 text-slate-400'">
                                <i :data-lucide="getCategoryIcon(cat)" class="w-3 h-3"></i> {{ getCategoryName(cat) }}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label">ÊôÇÈñì</label>
                            <input v-model="formEvent.time" type="time" class="input text-center font-bold">
                        </div>
                        <div v-if="formEvent.category === 'flight'">
                            <label class="label">Ëà™Áè≠Ëôü</label>
                            <input v-model="formEvent.flightNum" class="input text-center uppercase" placeholder="5J311">
                        </div>
                    </div>

                    <input v-model="formEvent.title" class="input font-bold" placeholder="ÂêçÁ®± (‰æã: Ubeco)">

                    <!-- Context Fields -->
                    <div v-if="['spot','food','shop'].includes(formEvent.category)" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label">ÁáüÊ•≠ÊôÇÈñì</label>
                            <input v-model="formEvent.hours" class="input" placeholder="09:00-21:00">
                        </div>
                        <div v-if="formEvent.category === 'spot'">
                            <label class="label">ÈñÄÁ•® (Peso)</label>
                            <input v-model="formEvent.ticket" class="input" placeholder="‚Ç±100">
                        </div>
                    </div>

                    <!-- Flight Fields -->
                    <div v-if="formEvent.category === 'flight'" class="bg-blue-50 p-3 rounded-xl grid grid-cols-2 gap-3">
                        <input v-model="formEvent.depCode" class="input text-center uppercase text-sm" placeholder="Âá∫ÁôºÊ©üÂ†¥ (TPE)">
                        <input v-model="formEvent.arrCode" class="input text-center uppercase text-sm" placeholder="ÊäµÈÅîÊ©üÂ†¥ (CEB)">
                        <input v-model="formEvent.endTime" type="time" class="input text-center" placeholder="ÊäµÈÅîÊôÇÈñì">
                    </div>

                    <!-- Transport to Next -->
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <label class="label mb-2">‰∫§ÈÄöÊñπÂºè (ÂâçÂæÄÊ≠§Èªû)</label>
                        <div class="flex gap-2">
                            <select v-model="formEvent.transportMode" class="input w-1/3 bg-white text-xs">
                                <option value="car">üöó ÂåÖËªä/Grab</option>
                                <option value="walk">üö∂ Ê≠•Ë°å</option>
                                <option value="bus">üöå ÂÖ¨Ëªä/Ëàπ</option>
                            </select>
                            <input v-model="formEvent.transportTime" class="input w-2/3 text-xs" placeholder="È†ê‰º∞ÊôÇÈñì (‰æã: 15 min)">
                        </div>
                    </div>

                    <textarea v-model="formEvent.note" class="input h-20 text-sm" placeholder="ÂÇôË®ª„ÄÅÁâπËâ≤..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button @click="showEventModal=false" class="btn-secondary">ÂèñÊ∂à</button>
                    <button @click="saveEvent" class="btn-primary">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>

        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 animate-slide-up">
                <h3 class="text-xl font-black text-slate-800 mb-4">Âä†ÂÖ•Ë≥ºÁâ©Ê∏ÖÂñÆ</h3>
                <input v-model="formShopping.name" class="input mb-4" placeholder="ÂïÜÂìÅÂêçÁ®±">
                <div class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 relative transition" @click="$refs.fileInput.click()">
                    <i data-lucide="camera" class="w-8 h-8 mx-auto text-slate-300 mb-2"></i>
                    <span class="text-xs text-slate-400 block">ÈªûÊìä‰∏äÂÇ≥ÂúñÁâá (ÈÅ∏Â°´)</span>
                    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleImageUpload">
                    <img v-if="formShopping.image" :src="formShopping.image" class="absolute inset-0 w-full h-full object-cover rounded-xl opacity-90">
                </div>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button @click="showShoppingModal=false" class="btn-secondary">ÂèñÊ∂à</button>
                    <button @click="saveShopping" class="btn-primary">Âä†ÂÖ•</button>
                </div>
            </div>
        </div>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 animate-slide-up">
                <h3 class="text-xl font-black text-slate-800 mb-4">Êñ∞Â¢ûËä±Ë≤ª</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label">Êó•Êúü</label>
                            <input type="date" v-model="formExpense.date" class="input text-sm">
                        </div>
                        <div>
                            <label class="label">È°ûÂà•</label>
                            <select v-model="formExpense.category" class="input bg-white text-sm">
                                <option value="food">È£≤È£ü</option>
                                <option value="transport">‰∫§ÈÄö</option>
                                <option value="hotel">‰ΩèÂÆø</option>
                                <option value="ticket">ÈñÄÁ•®</option>
                                <option value="shop">Ë≥ºÁâ©</option>
                                <option value="other">ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                    </div>
                    <input v-model="formExpense.name" class="input" placeholder="È†ÖÁõÆÂêçÁ®±">
                    <div class="relative">
                        <span class="absolute left-3 top-3.5 text-slate-400 font-mono">‚Ç±</span>
                        <input type="number" v-model="formExpense.amount" class="input pl-8 text-lg font-bold" placeholder="ÈáëÈ°ç">
                    </div>
                    <div>
                        <label class="label">‰ªòÊ¨æÊñπÂºè</label>
                        <div class="flex gap-2">
                            <button @click="formExpense.payment='cash'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-all" :class="formExpense.payment==='cash'?'bg-blue-50 border-blue-500 text-blue-600':'border-slate-200 text-slate-400'">üíµ ÁèæÈáë</button>
                            <button @click="formExpense.payment='card'" class="flex-1 py-2 rounded-xl text-xs font-bold border transition-all" :class="formExpense.payment==='card'?'bg-blue-50 border-blue-500 text-blue-600':'border-slate-200 text-slate-400'">üí≥ ‰ø°Áî®Âç°</button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button @click="showExpenseModal=false" class="btn-secondary">ÂèñÊ∂à</button>
                    <button @click="saveExpense" class="btn-primary">Ë®òÈåÑ</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- State & Data ---
                const currentTab = ref('schedule');
                const currentDateIndex = ref(0);
                const calcPHP = ref('');
                const currentWeather = ref({ temp: '--', feels_like: '--', desc: 'Loading...', icon: 'sun' });

                const tripDays = [
                    { date: '2026-02-11', dayShort: 'Fri 11', dateShort: '2/11', dayNum: '11', highlight: 'ÊäµÈÅîÂÆøÈúß' },
                    { date: '2026-02-12', dayShort: 'Sat 12', dateShort: '2/12', dayNum: '12', highlight: 'Â∏ÇÂçÄÂè§Ëπü' },
                    { date: '2026-02-13', dayShort: 'Sun 13', dateShort: '2/13', dayNum: '13', highlight: 'ÂâçÂæÄËñÑËç∑' },
                    { date: '2026-02-14', dayShort: 'Mon 14', dateShort: '2/14', dayNum: '14', highlight: 'Ê≤ô‰∏ÅÈ≠ö' },
                    { date: '2026-02-15', dayShort: 'Tue 15', dateShort: '2/15', dayNum: '15', highlight: 'Ë∑≥Â≥∂Êµ∑Èæú' },
                    { date: '2026-02-16', dayShort: 'Wed 16', dateShort: '2/16', dayNum: '16', highlight: 'Â∑ßÂÖãÂäõÂ±±' },
                    { date: '2026-02-17', dayShort: 'Thu 17', dateShort: '2/17', dayNum: '17', highlight: 'ÂõûÈ¶¨Â∞ºÊãâ' },
                    { date: '2026-02-18', dayShort: 'Fri 18', dateShort: '2/18', dayNum: '18', highlight: 'BGC & ËøîÂè∞' }
                ];

                const tabs = [
                    { id: 'schedule', label: 'Ë°åÁ®ã', icon: 'map-pin' },
                    { id: 'info', label: 'Ë≥áË®ä', icon: 'info' },
                    { id: 'shopping', label: 'Ë≥ºÁâ©', icon: 'shopping-bag' },
                    { id: 'expenses', label: 'Ëä±Ë≤ª', icon: 'coins' }
                ];

                // Lists
                const events = ref([]);
                const expenseList = ref([]);
                const shoppingList = ref([]);

                // Modals & Forms
                const showEventModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const isEditing = ref(false);
                const formEvent = ref({});
                const formShopping = ref({});
                const formExpense = ref({ date: new Date().toISOString().split('T')[0], payment: 'cash', category: 'food' });

                // --- Firebase Init ---
                onMounted(() => {
                    lucide.createIcons();
                    
                    window.addEventListener('firebase-ready', () => {
                        const { collection, onSnapshot, query, orderBy } = window.fireOps;
                        const db = window.db;

                        // Real-time Listeners
                        onSnapshot(query(collection(db, 'events_v4'), orderBy('order')), (snap) => {
                            events.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        onSnapshot(query(collection(db, 'shopping_v4')), (snap) => {
                            shoppingList.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        onSnapshot(query(collection(db, 'expenses_v4'), orderBy('date', 'desc')), (snap) => {
                            expenseList.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });

                        fetchWeather();
                    });
                });

                watch([currentTab, events], () => nextTick(() => lucide.createIcons()));

                // --- Computed ---
                const currentDayEvents = computed(() => {
                    const targetDate = tripDays[currentDateIndex.value].date;
                    // Sort by order index
                    return events.value.filter(e => e.date === targetDate).sort((a,b) => (a.order || 0) - (b.order || 0));
                });

                const totalExpense = computed(() => expenseList.value.reduce((sum, item) => sum + Number(item.amount || 0), 0));
                
                const currentCity = computed(() => {
                    const idx = currentDateIndex.value;
                    if(idx < 2) return 'Cebu City';
                    if(idx >= 2 && idx <= 5) return 'Bohol / Panglao';
                    return 'Manila BGC';
                });

                // --- Functions ---
                
                // Weather Mock
                const fetchWeather = async () => {
                    // Simulate dynamic weather
                    const weatherTypes = [
                        { temp: 30, feels_like: 33, desc: 'Êô¥ÊúóÁÇéÁÜ±', icon: 'sun' },
                        { temp: 28, feels_like: 31, desc: 'Â§öÈõ≤ÂÅ∂Èõ®', icon: 'cloud-rain' },
                        { temp: 29, feels_like: 32, desc: 'Èô∞Â§©ËàíÈÅ©', icon: 'cloud' }
                    ];
                    // Random pick for demo based on index to keep consistent
                    const w = weatherTypes[currentDateIndex.value % 3];
                    currentWeather.value = w;
                };

                // CRUD - Events
                const openAddModal = () => {
                    isEditing.value = false;
                    formEvent.value = {
                        date: tripDays[currentDateIndex.value].date,
                        category: 'spot',
                        transportMode: 'car',
                        order: currentDayEvents.value.length // Append to end
                    };
                    showEventModal.value = true;
                };

                const editEvent = (event) => {
                    isEditing.value = true;
                    formEvent.value = { ...event };
                    showEventModal.value = true;
                };

                const saveEvent = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.fireOps;
                    if (isEditing.value) {
                        await updateDoc(doc(window.db, 'events_v4', formEvent.value.id), formEvent.value);
                    } else {
                        await addDoc(collection(window.db, 'events_v4'), formEvent.value);
                    }
                    showEventModal.value = false;
                };

                const deleteEvent = async () => {
                    if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ãÔºü')) {
                        await window.fireOps.deleteDoc(window.fireOps.doc(window.db, 'events_v4', formEvent.value.id));
                        showEventModal.value = false;
                    }
                };

                // Navigation
                const openMap = (event) => {
                    const query = event.locationName || event.title;
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
                };

                // CRUD - Shopping (Image Upload)
                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        if(file.size > 800000) { alert('ÂúñÁâáÂ§™Â§ßÔºåË´ãÁ∏ÆÂ∞èÂæå‰∏äÂÇ≥'); return; }
                        const reader = new FileReader();
                        reader.onload = (e) => formShopping.value.image = e.target.result; // Base64
                        reader.readAsDataURL(file);
                    }
                };
                const saveShopping = async () => {
                    await window.fireOps.addDoc(window.fireOps.collection(window.db, 'shopping_v4'), formShopping.value);
                    showShoppingModal.value = false;
                    formShopping.value = {};
                };
                const toggleShopCheck = async (item) => {
                    await window.fireOps.updateDoc(window.fireOps.doc(window.db, 'shopping_v4', item.id), { checked: !item.checked });
                };

                // CRUD - Expenses
                const saveExpense = async () => {
                    await window.fireOps.addDoc(window.fireOps.collection(window.db, 'expenses_v4'), formExpense.value);
                    showExpenseModal.value = false;
                    formExpense.value = { date: tripDays[currentDateIndex.value].date, payment: 'cash', category: 'food' };
                };
                const deleteItem = async (col, id) => {
                    if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) await window.fireOps.deleteDoc(window.fireOps.doc(window.db, col, id));
                };

                // Drag & Drop
                let dragStartIndex = -1;
                const dragStart = (idx, e) => {
                    dragStartIndex = idx;
                    e.target.classList.add('dragging');
                };
                const dragDrop = async (dropIndex) => {
                    document.querySelector('.dragging')?.classList.remove('dragging');
                    if (dragStartIndex === dropIndex) return;

                    // Reorder locally
                    const items = [...currentDayEvents.value];
                    const [moved] = items.splice(dragStartIndex, 1);
                    items.splice(dropIndex, 0, moved);

                    // Batch update order in Firebase
                    const { writeBatch, doc } = window.fireOps;
                    const batch = writeBatch(window.db);
                    items.forEach((item, idx) => {
                        batch.update(doc(window.db, 'events_v4', item.id), { order: idx });
                    });
                    await batch.commit();
                };

                // Helpers
                const forceInit = async () => window.location.reload(); // Simple reload for sync
                const getCategoryIcon = (c) => ({ spot:'map-pin', food:'utensils', hotel:'bed', shop:'shopping-bag', flight:'plane', other:'circle' })[c] || 'circle';
                const getCategoryName = (c) => ({ spot:'ÊôØÈªû', food:'ÁæéÈ£ü', hotel:'‰ΩèÂÆø', shop:'Ë≥ºÁâ©', flight:'Ëà™Áè≠', other:'ÂÖ∂‰ªñ' })[c];
                const getCategoryColor = (c) => ({ spot:'bg-teal-500', food:'bg-orange-400', hotel:'bg-indigo-500', shop:'bg-pink-400', flight:'bg-blue-500', other:'bg-slate-400' })[c] || 'bg-slate-400';
                const getTransportIcon = (t) => ({ car:'car', walk:'footprints', bus:'bus', ship:'ship' })[t] || 'arrow-down';
                const getExpenseIcon = (c) => ({ food:'utensils', transport:'car', hotel:'bed', ticket:'ticket', shop:'shopping-bag', other:'coins' })[c] || 'coins';
                const getExpenseColor = (c) => ({ food:'bg-orange-100 text-orange-600', transport:'bg-blue-100 text-blue-600', hotel:'bg-indigo-100 text-indigo-600', ticket:'bg-purple-100 text-purple-600', shop:'bg-pink-100 text-pink-600', other:'bg-slate-100 text-slate-600' })[c];

                // Change Date
                const changeDate = (idx) => {
                    currentDateIndex.value = idx;
                    fetchWeather();
                };

                return {
                    currentTab, tripDays, currentDateIndex, currentDayEvents,
                    shoppingList, expenseList,
                    showEventModal, showShoppingModal, showExpenseModal, isEditing,
                    formEvent, formShopping, formExpense,
                    currentWeather, currentCity, calcPHP, totalExpense,
                    changeDate, openAddModal, editEvent, saveEvent, deleteEvent,
                    saveShopping, handleImageUpload, toggleShopCheck,
                    saveExpense, deleteItem,
                    openMap, forceInit,
                    getCategoryIcon, getCategoryName, getCategoryColor, getTransportIcon, getExpenseIcon, getExpenseColor,
                    dragStart, dragDrop
                };
            }
        }).mount('#app');
    </script>
    <style>
        .input { @apply w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all; }
        .label { @apply block text-xs font-bold text-slate-400 mb-1.5 ml-1; }
        .btn-primary { @apply bg-yellow-400 text-yellow-900 py-3 rounded-xl font-bold shadow-lg shadow-yellow-100 active:scale-95 transition-transform; }
        .btn-secondary { @apply py-3 text-slate-400 font-bold hover:bg-slate-50 rounded-xl transition-colors; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</body>
</html>
