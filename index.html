<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's Super Trip â˜ï¸</title>
    
    <!-- æ ¸å¿ƒåº« -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA1JHrkPbANS-g7X8OudpD0w819ZXA8-7A",
            authDomain: "family-trip-2026-1c43d.firebaseapp.com",
            projectId: "family-trip-2026-1c43d",
            storageBucket: "family-trip-2026-1c43d.firebasestorage.app",
            messagingSenderId: "157512457202",
            appId: "1:157512457202:web:b211df6298c0057e62e96b",
            measurementId: "G-LDQW10LQZ4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fireOps = { collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs, writeBatch };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { teal: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 900: '#134e4a' } },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                    boxShadow: { 'card': '0 4px 12px -2px rgba(0, 0, 0, 0.08)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .drag-over { border-top: 2px solid #14b8a6; }
        /* èˆªç­å¡ç‰‡å°ˆç”¨æ¨£å¼ */
        .ticket-cut {
            position: absolute; bottom: 30%; left: -6px; width: 12px; height: 12px;
            background-color: #f8fafc; border-radius: 50%;
        }
        .ticket-cut-r { left: auto; right: -6px; }
        .ticket-dash {
            position: absolute; bottom: 30%; left: 10px; right: 10px;
            border-bottom: 2px dashed #e2e8f0;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-700 font-sans overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto bg-slate-50 relative shadow-2xl">

        <!-- 1. è¡Œç¨‹è¡¨ (Schedule) -->
        <div v-if="currentTab === 'schedule'" class="flex flex-col h-full">
            <!-- Header with Date Scroller -->
            <header class="bg-white pt-10 pb-2 shadow-sm z-20">
                <div class="px-5 mb-3 flex justify-between items-end">
                    <div>
                        <h1 class="text-xl font-black text-teal-900 tracking-tight">Trip Schedule</h1>
                        <p class="text-xs text-slate-400">Remi Family Trip 2026</p>
                    </div>
                    <!-- Weather Widget (Auto) -->
                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-100">
                        <i :data-lucide="currentWeather.icon" class="w-5 h-5 text-amber-400"></i>
                        <div class="flex flex-col items-end leading-none">
                            <span class="text-sm font-bold text-slate-700">{{ currentWeather.temp }}Â°</span>
                            <span class="text-[9px] text-slate-400">é«”æ„Ÿ {{ currentWeather.feels_like }}Â°</span>
                        </div>
                    </div>
                </div>
                
                <!-- Horizontal Date List -->
                <div class="flex overflow-x-auto hide-scrollbar px-4 pb-2 gap-3 snap-x">
                    <button v-for="(day, idx) in tripDays" :key="day.date" @click="changeDate(idx)"
                        class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all duration-200 border snap-start"
                        :class="currentDateIndex === idx ? 'bg-teal-600 text-white shadow-lg shadow-teal-200 border-teal-600 transform -translate-y-1' : 'bg-white text-slate-400 border-slate-100'">
                        <span class="text-sm font-black">{{ day.dayShort }}</span>
                        <span class="text-xs font-medium opacity-80">{{ day.dayNum }}</span>
                    </button>
                </div>
            </header>

            <!-- Itinerary Content -->
            <main class="flex-1 overflow-y-auto p-4 space-y-0 hide-scrollbar pb-24">
                
                <!-- Empty State -->
                <div v-if="currentDayEvents.length === 0" class="flex flex-col items-center justify-center py-20 text-slate-300 opacity-60">
                    <i data-lucide="map" class="w-12 h-12 mb-3 stroke-1"></i>
                    <p class="text-sm">é»æ“Šå³ä¸‹è§’ + æ–°å¢è¡Œç¨‹</p>
                </div>

                <!-- Events List (Draggable) -->
                <div v-for="(event, index) in currentDayEvents" :key="event.id"
                     draggable="true"
                     @dragstart="dragStart(index, $event)"
                     @dragover.prevent
                     @drop="dragDrop(index)"
                     @touchstart="touchStart(index)"
                     @touchmove="touchMove"
                     @touchend="dragDrop(index)"
                     class="relative group transition-all duration-200">
                    
                    <!-- Transport Connector (Previous -> Current) -->
                    <div v-if="index > 0" class="flex flex-col items-center py-2 relative h-14">
                        <div class="w-0.5 h-full bg-slate-200 absolute top-0 z-0"></div>
                        <div class="z-10 bg-slate-50 border border-slate-200 px-3 py-1 rounded-full flex items-center gap-1.5 shadow-sm text-[10px] text-slate-500 cursor-pointer hover:bg-white"
                             @click="editEvent(event)">
                            <i :data-lucide="getTransportIcon(event.transportMode)" class="w-3 h-3"></i>
                            <span>{{ event.transportTime || 'è¨ˆç®—ä¸­...' }}</span>
                        </div>
                    </div>
                    <!-- First Item Transport (From Hotel) -->
                    <div v-else class="flex flex-col items-center py-2 relative h-10">
                         <div class="w-0.5 h-1/2 bg-slate-200 absolute bottom-0 z-0"></div>
                         <div class="z-10 bg-slate-100 px-2 py-0.5 rounded-md text-[10px] text-slate-400 mb-1 flex items-center gap-1">
                            <i data-lucide="bed" class="w-3 h-3"></i> å¾é£¯åº—å‡ºç™¼
                         </div>
                    </div>

                    <!-- Card Body -->
                    <div class="bg-white rounded-2xl shadow-card border border-slate-100 p-0 overflow-hidden relative active:scale-95 transition-transform"
                         :class="{'bg-teal-50 border-teal-200': event.category === 'flight'}">
                        
                        <!-- Flight Special Style -->
                        <div v-if="event.category === 'flight'" class="p-4">
                            <div class="ticket-cut"></div><div class="ticket-cut ticket-cut-r"></div><div class="ticket-dash"></div>
                            <div class="flex justify-between items-center mb-6">
                                <div class="text-2xl font-black text-teal-800">{{ event.depCode || 'TPE' }}</div>
                                <div class="flex flex-col items-center">
                                    <i data-lucide="plane" class="w-5 h-5 text-teal-500 rotate-90"></i>
                                    <span class="text-[10px] text-teal-600 font-mono mt-1">{{ event.flightNum || 'Flight' }}</span>
                                </div>
                                <div class="text-2xl font-black text-teal-800">{{ event.arrCode || 'CEB' }}</div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-slate-400">DEPART</div>
                                    <div class="font-bold text-slate-700">{{ event.time }}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-400">ARRIVE</div>
                                    <div class="font-bold text-slate-700">{{ event.endTime || '--:--' }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Normal Card Style -->
                        <div v-else class="p-4 flex gap-4" @click="openMap(event.title)">
                            <div class="flex flex-col items-center gap-1 pt-1">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm"
                                     :class="getCategoryColor(event.category)">
                                    <i :data-lucide="getCategoryIcon(event.category)" class="w-5 h-5"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-400 font-mono">{{ event.time }}</span>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-lg text-slate-800 leading-tight truncate">{{ event.title }}</h3>
                                    <!-- Edit Button (Small) -->
                                    <button @click.stop="editEvent(event)" class="text-slate-300 hover:text-teal-500 p-1"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                                </div>
                                
                                <!-- Info Tags -->
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <span v-if="event.hours" class="text-[10px] bg-slate-50 border border-slate-200 px-2 py-0.5 rounded text-slate-500 flex items-center">
                                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i> {{ event.hours }}
                                    </span>
                                    <span v-if="event.ticket" class="text-[10px] bg-yellow-50 border border-yellow-200 px-2 py-0.5 rounded text-yellow-700 flex items-center">
                                        <i data-lucide="ticket" class="w-3 h-3 mr-1"></i> {{ event.ticket }}
                                    </span>
                                </div>

                                <!-- Note -->
                                <p v-if="event.note" class="text-xs text-slate-500 mt-2 line-clamp-2 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    {{ event.note }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- FAB Add Button -->
            <button @click="openModal()" class="absolute bottom-24 right-5 w-14 h-14 bg-teal-600 rounded-full shadow-lg shadow-teal-200 text-white flex items-center justify-center hover:scale-105 transition-all active:scale-95 z-30">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- 2. è³‡è¨Š (Info) -->
        <div v-else-if="currentTab === 'info'" class="flex flex-col h-full bg-slate-100 p-4 space-y-4 overflow-y-auto pb-24">
            <h1 class="text-2xl font-black text-slate-800 mt-8 mb-2 px-2">Travel Info</h1>
            
            <!-- Rate Calculator -->
            <div class="bg-teal-600 rounded-2xl p-5 text-white shadow-lg">
                <h3 class="text-sm font-bold opacity-80 mb-4 flex items-center"><i data-lucide="arrow-left-right" class="w-4 h-4 mr-2"></i> åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-end gap-3">
                    <div class="flex-1">
                        <label class="text-xs opacity-70 block mb-1">PHP (æŠ«ç´¢)</label>
                        <input type="number" v-model="calcPHP" @input="calcToTWD" class="w-full bg-white/20 border-0 rounded-xl text-2xl font-mono p-2 text-white placeholder-white/50 focus:ring-2 focus:ring-white">
                    </div>
                    <div class="pb-3 font-bold">=</div>
                    <div class="flex-1">
                        <label class="text-xs opacity-70 block mb-1">TWD (å°å¹£)</label>
                        <div class="text-2xl font-mono p-2">{{ calcTWD }}</div>
                    </div>
                </div>
                <div class="text-[10px] text-right mt-2 opacity-60">åŒ¯ç‡: {{ exchangeRate }}</div>
            </div>

            <!-- Flights (Static from Image) -->
            <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center"><i data-lucide="plane" class="w-4 h-4 mr-2 text-blue-500"></i> èˆªç­è³‡è¨Š</h3>
                <div class="space-y-4">
                    <div class="border-l-4 border-blue-500 pl-3">
                        <div class="text-xs text-slate-400">å»ç¨‹ 2/11</div>
                        <div class="font-bold">TPE 03:15 -> CEB 12:25</div>
                        <div class="text-xs text-slate-500 mt-1">5J311 / 5J585 (MNLè½‰æ©Ÿ)</div>
                    </div>
                    <div class="border-l-4 border-orange-500 pl-3">
                        <div class="text-xs text-slate-400">å›ç¨‹ 2/18</div>
                        <div class="font-bold">MNL 23:35 -> TPE 02:00</div>
                        <div class="text-xs text-slate-500 mt-1">5J310 (T3èˆªå»ˆ)</div>
                    </div>
                </div>
            </div>

            <!-- Hotel & Emergency -->
            <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center"><i data-lucide="bed" class="w-4 h-4 mr-2 text-indigo-500"></i> ä½å®¿è³‡è¨Š</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center pb-2 border-b border-slate-50">
                        <span>å®¿éœ§ Marco Polo</span>
                        <a href="https://maps.google.com/?q=Marco+Polo+Plaza+Cebu" target="_blank" class="text-teal-600 bg-teal-50 p-1.5 rounded-lg"><i data-lucide="navigation" class="w-4 h-4"></i></a>
                    </div>
                    <div class="flex justify-between items-center pb-2 border-b border-slate-50">
                        <span>è–„è· Best Western</span>
                        <a href="https://maps.google.com/?q=Best+Western+Plus+The+Ivywall+Resort-Panglao" target="_blank" class="text-teal-600 bg-teal-50 p-1.5 rounded-lg"><i data-lucide="navigation" class="w-4 h-4"></i></a>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center"><i data-lucide="siren" class="w-4 h-4 mr-2 text-red-500"></i> ç·Šæ€¥é†«ç™‚</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-red-50 p-3 rounded-xl text-red-600">
                        <div class="text-xs">è­¦å¯Ÿ</div>
                        <div class="font-black text-xl">117</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded-xl text-red-600">
                        <div class="text-xs">æ•‘è­·è»Š</div>
                        <div class="font-black text-xl">168</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. è³¼ç‰© (Shopping) -->
        <div v-if="currentTab === 'shopping'" class="flex flex-col h-full bg-white p-4 pb-24">
            <h1 class="text-2xl font-black text-slate-800 mt-8 mb-4 px-2">Shopping List</h1>
            <div class="grid grid-cols-2 gap-4 overflow-y-auto hide-scrollbar">
                <div v-for="item in shoppingList" :key="item.id" class="bg-slate-50 rounded-2xl p-3 border border-slate-100 relative group">
                    <button @click="deleteItem('shopping', item.id)" class="absolute top-2 right-2 bg-white/80 rounded-full p-1 text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                    <div class="aspect-square bg-white rounded-xl mb-3 flex items-center justify-center overflow-hidden border border-slate-100">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <i v-else data-lucide="image" class="w-8 h-8 text-slate-200"></i>
                    </div>
                    <h4 class="font-bold text-slate-700 text-sm truncate">{{ item.name }}</h4>
                    <div class="flex items-center gap-1 mt-1">
                        <input type="checkbox" class="rounded text-teal-600 focus:ring-0">
                        <span class="text-xs text-slate-400">æœªè³¼è²·</span>
                    </div>
                </div>
            </div>
            <button @click="showShoppingModal=true" class="absolute bottom-24 right-5 w-14 h-14 bg-teal-600 rounded-full shadow-lg text-white flex items-center justify-center z-30">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- 4. èŠ±è²» (Expenses) -->
        <div v-if="currentTab === 'expenses'" class="flex flex-col h-full bg-slate-50 p-4 pb-24">
            <h1 class="text-2xl font-black text-slate-800 mt-8 mb-4 px-2">Expenses</h1>
            
            <!-- Total -->
            <div class="bg-slate-800 rounded-2xl p-6 text-white shadow-xl mb-6 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">Total Spent</div>
                    <div class="text-4xl font-mono font-bold">â‚± {{ totalExpense.toLocaleString() }}</div>
                    <div class="text-xs text-slate-500 mt-2">ç´„ NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</div>
                </div>
                <div class="absolute right-[-20px] top-[-20px] w-32 h-32 bg-teal-500 rounded-full opacity-20 blur-2xl"></div>
            </div>

            <!-- List -->
            <div class="space-y-3 overflow-y-auto hide-scrollbar flex-1">
                <div v-for="ex in expenseList" :key="ex.id" class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center text-lg">
                            <i :data-lucide="getExpenseIcon(ex.category)" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <div class="font-bold text-slate-700">{{ ex.name }}</div>
                            <div class="text-[10px] text-slate-400">{{ ex.date }} â€¢ {{ ex.payment }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold font-mono">â‚±{{ ex.amount }}</div>
                        <button @click="deleteItem('expenses', ex.id)" class="text-[10px] text-red-300">åˆªé™¤</button>
                    </div>
                </div>
            </div>
            <button @click="showExpenseModal=true" class="absolute bottom-24 right-5 w-14 h-14 bg-teal-600 rounded-full shadow-lg text-white flex items-center justify-center z-30">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- Navigation Bar -->
        <nav class="bg-white border-t border-slate-100 h-20 fixed bottom-0 w-full max-w-md flex justify-around items-center px-2 z-40 pb-2">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" 
                class="flex flex-col items-center justify-center w-16 h-full transition-all"
                :class="currentTab === tab.id ? 'text-teal-600' : 'text-slate-300'">
                <div class="relative p-1">
                    <i :data-lucide="tab.icon" class="w-6 h-6 transition-all" :class="{'fill-teal-100 stroke-teal-600': currentTab === tab.id}"></i>
                    <div v-if="currentTab === tab.id" class="absolute -top-1 right-0 w-2 h-2 bg-teal-500 rounded-full"></div>
                </div>
                <span class="text-[10px] font-medium mt-1">{{ tab.label }}</span>
            </button>
        </nav>

        <!-- === Modals === -->

        <!-- Event Modal (Add/Edit) -->
        <div v-if="showEventModal" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 animate-slide-up shadow-2xl max-h-[85vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-slate-800">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                    <button v-if="isEditing" @click="deleteEvent" class="text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold">åˆªé™¤</button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label">æ™‚é–“</label>
                            <input v-model="formEvent.time" type="time" class="input">
                        </div>
                        <div>
                            <label class="label">åˆ†é¡</label>
                            <select v-model="formEvent.category" class="input bg-white">
                                <option value="spot">ğŸ“ æ™¯é»</option>
                                <option value="food">ğŸ´ ç¾é£Ÿ</option>
                                <option value="hotel">ğŸ¨ ä½å®¿</option>
                                <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="flight">âœˆï¸ èˆªç­</option>
                                <option value="other">ğŸ”¹ å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="label">åç¨±</label>
                        <input v-model="formEvent.title" class="input" placeholder="ä¾‹å¦‚ï¼šCebu Ocean Park">
                    </div>
                    <div v-if="['spot','food','shop'].includes(formEvent.category)" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label">ç‡Ÿæ¥­æ™‚é–“</label>
                            <input v-model="formEvent.hours" class="input" placeholder="09:00-18:00">
                        </div>
                        <div v-if="formEvent.category === 'spot'">
                            <label class="label">é–€ç¥¨ (Peso)</label>
                            <input v-model="formEvent.ticket" class="input" placeholder="â‚±800">
                        </div>
                    </div>
                    
                    <!-- Flight Specifics -->
                    <div v-if="formEvent.category === 'flight'" class="grid grid-cols-2 gap-4 bg-blue-50 p-3 rounded-xl">
                        <input v-model="formEvent.depCode" class="input text-center uppercase" placeholder="TPE">
                        <input v-model="formEvent.arrCode" class="input text-center uppercase" placeholder="CEB">
                        <input v-model="formEvent.flightNum" class="input col-span-2 text-center" placeholder="5J311">
                    </div>

                    <div>
                        <label class="label">äº¤é€šè‡³æ­¤é» (æ–¹å¼/æ™‚é–“)</label>
                        <div class="flex gap-2">
                            <select v-model="formEvent.transportMode" class="input w-1/3 bg-white">
                                <option value="car">ğŸš— åŒ…è»Š/Grab</option>
                                <option value="walk">ğŸš¶ æ­¥è¡Œ</option>
                                <option value="bus">ğŸšŒ å¤§çœ¾é‹è¼¸</option>
                                <option value="ship">ğŸš¢ èˆ¹</option>
                            </select>
                            <input v-model="formEvent.transportTime" class="input w-2/3" placeholder="ä¾‹å¦‚ï¼š15 min">
                        </div>
                    </div>

                    <div>
                        <label class="label">ç‰¹è‰² & å‚™è¨»</label>
                        <textarea v-model="formEvent.note" class="input h-20" placeholder="å¿…åƒã€æ³¨æ„äº‹é …..."></textarea>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button @click="showEventModal=false" class="btn-secondary">å–æ¶ˆ</button>
                    <button @click="saveEvent" class="btn-primary">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 animate-slide-up">
                <h3 class="text-xl font-black text-slate-800 mb-4">è¨˜ä¸€ç­†</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label">æ—¥æœŸ</label>
                            <input type="date" v-model="formExpense.date" class="input">
                        </div>
                        <div>
                            <label class="label">åˆ†é¡</label>
                            <select v-model="formExpense.category" class="input bg-white">
                                <option value="food">é£²é£Ÿ</option>
                                <option value="transport">äº¤é€š</option>
                                <option value="ticket">é–€ç¥¨</option>
                                <option value="shop">è³¼ç‰©</option>
                                <option value="hotel">ä½å®¿</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <input v-model="formExpense.name" class="input" placeholder="é …ç›®åç¨±">
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-400 font-mono">â‚±</span>
                        <input type="number" v-model="formExpense.amount" class="input pl-8 text-lg font-bold" placeholder="é‡‘é¡">
                    </div>
                    <div class="flex gap-2">
                        <button @click="formExpense.payment='cash'" class="flex-1 py-2 rounded-lg border text-sm font-bold" :class="formExpense.payment==='cash'?'bg-teal-50 border-teal-500 text-teal-600':'border-slate-200 text-slate-400'">ç¾é‡‘</button>
                        <button @click="formExpense.payment='card'" class="flex-1 py-2 rounded-lg border text-sm font-bold" :class="formExpense.payment==='card'?'bg-teal-50 border-teal-500 text-teal-600':'border-slate-200 text-slate-400'">åˆ·å¡</button>
                    </div>
                </div>
                <button @click="saveExpense" class="btn-primary mt-6 w-full">è¨˜éŒ„</button>
                <button @click="showExpenseModal=false" class="text-slate-400 text-sm w-full mt-3">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 animate-slide-up">
                <h3 class="text-xl font-black text-slate-800 mb-4">æƒ³è²·æ¸…å–®</h3>
                <input v-model="formShopping.name" class="input mb-4" placeholder="å•†å“åç¨±">
                <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50 relative" @click="$refs.fileInput.click()">
                    <i data-lucide="camera" class="w-6 h-6 mx-auto text-slate-300 mb-1"></i>
                    <span class="text-xs text-slate-400">ä¸Šå‚³åœ–ç‰‡ (é¸å¡«, é™1å¼µ)</span>
                    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleImageUpload">
                    <img v-if="formShopping.image" :src="formShopping.image" class="absolute inset-0 w-full h-full object-cover rounded-xl opacity-80">
                </div>
                <button @click="saveShopping" class="btn-primary mt-6 w-full">åŠ å…¥æ¸…å–®</button>
                <button @click="showShoppingModal=false" class="text-slate-400 text-sm w-full mt-3">å–æ¶ˆ</button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- State ---
                const currentTab = ref('schedule');
                const currentDateIndex = ref(0);
                const exchangeRate = ref(0.56); // é è¨­
                const calcPHP = ref('');
                const calcTWD = ref('0');
                const currentWeather = ref({ temp: '--', feels_like: '--', icon: 'sun' });

                // Data
                const tabs = [
                    { id: 'schedule', label: 'è¡Œç¨‹', icon: 'map-pin' },
                    { id: 'info', label: 'è³‡è¨Š', icon: 'info' },
                    { id: 'shopping', label: 'è³¼ç‰©', icon: 'shopping-bag' },
                    { id: 'expenses', label: 'èŠ±è²»', icon: 'banknote' }
                ];
                
                const tripDays = [
                    { date: '2026-02-11', dayShort: 'é€±ä¸‰', dayNum: '11' },
                    { date: '2026-02-12', dayShort: 'é€±å››', dayNum: '12' },
                    { date: '2026-02-13', dayShort: 'é€±äº”', dayNum: '13' },
                    { date: '2026-02-14', dayShort: 'é€±å…­', dayNum: '14' },
                    { date: '2026-02-15', dayShort: 'é€±æ—¥', dayNum: '15' },
                    { date: '2026-02-16', dayShort: 'é€±ä¸€', dayNum: '16' },
                    { date: '2026-02-17', dayShort: 'é€±äºŒ', dayNum: '17' },
                    { date: '2026-02-18', dayShort: 'é€±ä¸‰', dayNum: '18' }
                ];

                const events = ref([]);
                const expenseList = ref([]);
                const shoppingList = ref([]);

                // Modals
                const showEventModal = ref(false);
                const showExpenseModal = ref(false);
                const showShoppingModal = ref(false);
                const isEditing = ref(false);

                // Forms
                const formEvent = ref({});
                const formExpense = ref({ date: new Date().toISOString().split('T')[0], payment: 'cash' });
                const formShopping = ref({});

                // --- Firebase Listeners ---
                onMounted(() => {
                    lucide.createIcons();
                    
                    window.addEventListener('firebase-ready', () => {
                        const { collection, onSnapshot, query, orderBy } = window.fireOps;
                        const db = window.db;

                        // Events
                        onSnapshot(query(collection(db, 'events_v3'), orderBy('order')), (snap) => {
                            events.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        // Expenses
                        onSnapshot(query(collection(db, 'expenses_v3'), orderBy('date', 'desc')), (snap) => {
                            expenseList.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        // Shopping
                        onSnapshot(collection(db, 'shopping_v3'), (snap) => {
                            shoppingList.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        
                        fetchWeather();
                    });
                });

                watch([currentTab, events, expenseList], () => nextTick(() => lucide.createIcons()));

                // --- Computed ---
                const currentDayEvents = computed(() => {
                    return events.value.filter(e => e.date === tripDays[currentDateIndex.value].date).sort((a,b) => a.order - b.order);
                });

                const totalExpense = computed(() => {
                    return expenseList.value.reduce((sum, item) => sum + Number(item.amount), 0);
                });

                // --- Methods ---
                
                // Weather Mock (Or fetch from OpenMeteo)
                const fetchWeather = async () => {
                    // ç°¡å–®æ¨¡æ“¬ï¼Œå¯¦éš›å¯æ¥ API
                    const targetLat = 10.31; // Cebu
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${targetLat}&longitude=123.89&current_weather=true`);
                        const data = await res.json();
                        currentWeather.value = {
                            temp: Math.round(data.current_weather.temperature),
                            feels_like: Math.round(data.current_weather.temperature + 2),
                            icon: 'sun' // ç°¡åŒ–
                        };
                    } catch(e) {}
                };

                // Calculator
                const calcToTWD = () => {
                    if(!calcPHP.value) calcTWD.value = 0;
                    else calcTWD.value = (calcPHP.value * exchangeRate.value).toFixed(0);
                };

                // Event CRUD
                const openModal = () => {
                    isEditing.value = false;
                    formEvent.value = { 
                        date: tripDays[currentDateIndex.value].date,
                        category: 'spot',
                        transportMode: 'car',
                        order: currentDayEvents.value.length
                    };
                    showEventModal.value = true;
                };

                const editEvent = (event) => {
                    isEditing.value = true;
                    formEvent.value = { ...event };
                    showEventModal.value = true;
                };

                const saveEvent = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.fireOps;
                    const db = window.db;
                    
                    if (isEditing.value) {
                        await updateDoc(doc(db, 'events_v3', formEvent.value.id), formEvent.value);
                    } else {
                        await addDoc(collection(db, 'events_v3'), formEvent.value);
                    }
                    showEventModal.value = false;
                };

                const deleteEvent = async () => {
                    if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                        const { deleteDoc, doc } = window.fireOps;
                        await deleteDoc(doc(window.db, 'events_v3', formEvent.value.id));
                        showEventModal.value = false;
                    }
                };

                // Drag & Drop Logic (Simple Swap)
                let dragStartIndex = -1;
                const dragStart = (idx, e) => {
                    dragStartIndex = idx;
                    e.dataTransfer.effectAllowed = 'move';
                    e.target.classList.add('dragging');
                };
                const dragDrop = async (dropIndex) => {
                    document.querySelector('.dragging')?.classList.remove('dragging');
                    if (dragStartIndex === dropIndex) return;

                    // Swap orders in local first then batch update
                    const items = [...currentDayEvents.value];
                    const movedItem = items[dragStartIndex];
                    items.splice(dragStartIndex, 1);
                    items.splice(dropIndex, 0, movedItem);

                    // Update all orders in Firebase
                    const { writeBatch, doc } = window.fireOps;
                    const batch = writeBatch(window.db);
                    items.forEach((item, idx) => {
                        const ref = doc(window.db, 'events_v3', item.id);
                        batch.update(ref, { order: idx });
                    });
                    await batch.commit();
                };

                // Expenses & Shopping CRUD (Simplified)
                const saveExpense = async () => {
                    await window.fireOps.addDoc(window.fireOps.collection(window.db, 'expenses_v3'), formExpense.value);
                    showExpenseModal.value = false;
                    formExpense.value = { date: new Date().toISOString().split('T')[0], payment: 'cash' };
                };

                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        if(file.size > 500000) { alert('åœ–ç‰‡å¤ªå¤§ï¼Œè«‹ç¸®å°'); return; }
                        const reader = new FileReader();
                        reader.onload = (e) => formShopping.value.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };

                const saveShopping = async () => {
                    await window.fireOps.addDoc(window.fireOps.collection(window.db, 'shopping_v3'), formShopping.value);
                    showShoppingModal.value = false;
                    formShopping.value = {};
                };

                const deleteItem = async (col, id) => {
                    if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                        await window.fireOps.deleteDoc(window.fireOps.doc(window.db, `${col}_v3`, id));
                    }
                };

                // Navigation
                const openMap = (keyword) => {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank');
                };

                // Icons Helpers
                const getCategoryIcon = (c) => ({ spot: 'map-pin', food: 'utensils', hotel: 'bed', shop: 'shopping-bag', flight: 'plane', other: 'circle' })[c] || 'circle';
                const getCategoryColor = (c) => ({ spot: 'bg-teal-500', food: 'bg-orange-400', hotel: 'bg-indigo-500', shop: 'bg-pink-400', flight: 'bg-blue-500', other: 'bg-slate-400' })[c] || 'bg-slate-400';
                const getTransportIcon = (t) => ({ car: 'car', walk: 'footprints', bus: 'bus', ship: 'ship' })[t] || 'arrow-down';
                const getExpenseIcon = (c) => ({ food: 'utensils', transport: 'car', ticket: 'ticket', shop: 'shopping-bag', hotel: 'bed', other: 'banknote' })[c];

                return {
                    currentTab, tripDays, currentDateIndex, currentDayEvents, expenseList, shoppingList,
                    totalExpense, exchangeRate, calcPHP, calcTWD, currentWeather,
                    showEventModal, showExpenseModal, showShoppingModal, formEvent, formExpense, formShopping, isEditing,
                    changeDate: (i) => currentDateIndex.value = i,
                    openModal, editEvent, saveEvent, deleteEvent,
                    saveExpense, saveShopping, handleImageUpload, deleteItem,
                    openMap, calcToTWD,
                    getCategoryIcon, getCategoryColor, getTransportIcon, getExpenseIcon,
                    dragStart, dragDrop
                };
            }
        }).mount('#app');
    </script>
    <style>
        /* CSS Utilities */
        .btn-primary { @apply bg-teal-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-teal-100 active:scale-95 transition-transform; }
        .btn-secondary { @apply py-3 text-slate-400 font-bold hover:bg-slate-50 rounded-xl transition-colors; }
        .input { @apply w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all; }
        .label { @apply block text-xs font-bold text-slate-400 mb-1 ml-1; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</body>
</html>
