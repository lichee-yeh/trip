<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's Family Trip ‚òÅÔ∏è</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase Ë®≠ÂÆö (Â∑≤Êï¥ÂêàÊÇ®ÁöÑÊà™ÂúñË≥áË®ä) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // ‚ñº‚ñº‚ñº ÊÇ®ÁöÑÂ∞àÂ±¨Èë∞Âåô (Â∑≤Â°´ÂÖ•) ‚ñº‚ñº‚ñº
        const firebaseConfig = {
            apiKey: "AIzaSyA1JHrkPbANS-g7X8OudpD0w819ZXA8-7A",
            authDomain: "family-trip-2026-1c43d.firebaseapp.com",
            projectId: "family-trip-2026-1c43d",
            storageBucket: "family-trip-2026-1c43d.firebasestorage.app",
            messagingSenderId: "157512457202",
            appId: "1:157512457202:web:b211df6298c0057e62e96b",
            measurementId: "G-LDQW10LQZ4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firestoreOps = { collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- Â≠óÈ´îËàáÊ®£Âºè -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { teal: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 900: '#134e4a' } },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    boxShadow: { 'float': '0 10px 30px -10px rgba(20, 184, 166, 0.3)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        #map-container { height: 100%; width: 100%; z-index: 0; }
        .custom-div-icon { background: #14b8a6; color: white; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-600 font-sans">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto bg-slate-50 relative shadow-2xl">

        <!-- Loading Screen -->
        <div v-if="!firebaseReady" class="absolute inset-0 z-[9999] bg-white flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-teal-200 border-t-teal-500 rounded-full animate-spin mb-4"></div>
            <p class="text-teal-600 font-bold animate-pulse">Ê≠£Âú®ÈÄ£Á∑öÈõ≤Á´ØË°åÁ®ã...</p>
        </div>

        <!-- Header -->
        <header class="px-5 pt-12 pb-3 bg-white/90 backdrop-blur-md z-30 sticky top-0 border-b border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-bold text-teal-900 tracking-tight">Remi Family Trip</h1>
                        <span class="flex h-2 w-2 relative">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                    </div>
                    <p class="text-xs text-slate-400 mt-0.5">4Â§ß1Â∞è1ËÄÅ ‚Ä¢ ÂÆøÈúßËñÑËç∑Â≥∂</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-teal-50 flex items-center justify-center text-lg border border-teal-100 shadow-sm">
                    üëßüèª
                </div>
            </div>

            <!-- Êó•ÊúüÊªëÂãïÂàó -->
            <div v-if="currentTab !== 'money'" class="flex space-x-3 overflow-x-auto hide-scrollbar pb-1">
                <button v-for="(day, index) in tripDays" :key="index" @click="changeDate(index)"
                    class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all duration-300 border relative overflow-hidden snap-start"
                    :class="currentDateIndex === index ? 'bg-teal-500 text-white shadow-float border-teal-500 transform scale-105' : 'bg-white text-slate-400 border-slate-100 hover:border-teal-200'">
                    <span class="text-[10px] opacity-80 uppercase font-medium">{{ day.dayShort }}</span>
                    <span class="text-lg font-bold">{{ day.dayNum }}</span>
                    <div v-if="hasEvent(day.date)" class="absolute bottom-1.5 w-1 h-1 rounded-full transition-colors" :class="currentDateIndex === index ? 'bg-white' : 'bg-teal-400'"></div>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative bg-slate-50 hide-scrollbar scroll-smooth">
            
            <!-- Tab 1: Ë°åÁ®ãË°® -->
            <transition name="fade">
                <div v-if="currentTab === 'schedule'" class="px-4 py-6 space-y-5 pb-24">
                    
                    <!-- Empty State -->
                    <div v-if="currentDayEvents.length === 0" class="flex flex-col items-center justify-center py-20 text-slate-300 opacity-60">
                        <i data-lucide="coffee" class="w-12 h-12 mb-3 stroke-1"></i>
                        <p class="text-sm font-medium">Êú¨Êó•Â∞öÁÑ°Ë°åÁ®ã</p>
                        <button @click="showEventModal = true" class="mt-4 text-teal-600 text-xs font-bold border border-teal-200 px-4 py-2 rounded-full hover:bg-teal-50">Êñ∞Â¢ûÁ¨¨‰∏ÄÁ≠Ü</button>
                    </div>

                    <!-- Event Cards -->
                    <div v-for="event in currentDayEvents" :key="event.id" class="group bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex gap-4 relative overflow-hidden transition-all hover:shadow-md">
                        
                        <!-- Side Decoration -->
                        <div class="absolute left-0 top-0 bottom-0 w-1 transition-colors" 
                             :class="event.type === 'food' ? 'bg-orange-400' : event.type === 'transport' ? 'bg-blue-400' : 'bg-teal-400'"></div>
                        
                        <!-- Time Column -->
                        <div class="flex flex-col items-center min-w-[3.5rem] pt-0.5 border-r border-slate-50 pr-3">
                            <span class="text-lg font-bold text-slate-700 font-sans tracking-tight">{{ event.time }}</span>
                            <div v-if="event.weather" class="mt-2 text-xs flex flex-col items-center text-amber-500 bg-amber-50 px-1 py-0.5 rounded">
                                <i :data-lucide="getWeatherIcon(event.weather.code)" class="w-3 h-3 mb-0.5"></i>
                                <span class="scale-90 font-bold">{{ event.weather.temp }}¬∞</span>
                            </div>
                        </div>

                        <!-- Content Column -->
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-slate-800 text-base leading-tight truncate pr-2">{{ event.title }}</h3>
                                <!-- Actions -->
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="openMapForEvent(event)" class="text-slate-300 hover:text-teal-500"><i data-lucide="map" class="w-4 h-4"></i></button>
                                    <button @click="deleteEvent(event.id)" class="text-slate-300 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            
                            <p class="text-xs text-slate-400 mt-1 flex items-center">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> {{ event.locationName }}
                            </p>
                            
                            <!-- Tags -->
                            <div class="mt-3 flex gap-2">
                                <span class="px-2 py-0.5 rounded-md text-[10px] font-bold border"
                                    :class="event.type === 'food' ? 'bg-orange-50 text-orange-600 border-orange-100' : 
                                            event.type === 'transport' ? 'bg-blue-50 text-blue-600 border-blue-100' : 
                                            'bg-teal-50 text-teal-600 border-teal-100'">
                                    {{ getTypeName(event.type) }}
                                </span>
                                <span v-if="event.tag" class="px-2 py-0.5 bg-slate-50 text-slate-500 rounded-md text-[10px] border border-slate-100 flex items-center">
                                    <i data-lucide="star" class="w-2 h-2 mr-1 text-orange-400 fill-orange-400"></i> {{ event.tag }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Tab 2: ÂàÜÂ∏≥ -->
            <transition name="fade">
                <div v-if="currentTab === 'money'" class="px-4 py-6 space-y-6 pb-24">
                    <!-- Total Card -->
                    <div class="bg-gradient-to-br from-teal-500 to-emerald-600 rounded-3xl p-6 text-white shadow-float relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-teal-50 text-xs font-medium uppercase tracking-wider">Total Expenses</span>
                            <button @click="showRateModal=true" class="text-[10px] bg-white/20 px-2 py-1 rounded hover:bg-white/30 transition">ÂåØÁéá {{exchangeRate}}</button>
                        </div>
                        <div class="text-4xl font-bold tracking-tight">
                            <span class="text-xl opacity-80 mr-1">NT$</span>{{ formatNumber(totalExpenseTwd) }}
                        </div>
                        <div class="pt-5 mt-2 border-t border-white/10 grid grid-cols-2 gap-3">
                            <div v-for="(bal, name) in balances" :key="name" class="flex justify-between items-center bg-black/10 rounded-lg px-3 py-2">
                                <span class="text-xs font-bold opacity-90">{{ name }}</span>
                                <span class="text-xs font-bold" :class="bal >= 0 ? 'text-teal-100' : 'text-rose-200'">{{ bal >= 0 ? '+' : '' }}{{ formatNumber(bal) }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- List -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center px-1">
                            <h3 class="font-bold text-slate-700 text-sm">Ê∂àË≤ªÊòéÁ¥∞</h3>
                            <button @click="showExpenseModal = true" class="flex items-center text-xs bg-white border border-slate-200 px-3 py-1.5 rounded-full text-slate-600 shadow-sm hover:bg-slate-50"><i data-lucide="plus" class="w-3 h-3 mr-1"></i> Ë®ò‰∏ÄÁ≠Ü</button>
                        </div>
                        <div v-for="ex in expenses" :key="ex.id" class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-lg border border-slate-100">{{ getAvatar(ex.payer) }}</div>
                                <div>
                                    <div class="font-bold text-slate-700 text-sm">{{ ex.item }}</div>
                                    <div class="text-[10px] text-slate-400 mt-0.5 font-medium">{{ ex.payer }} ‚Ä¢ {{ ex.currency }} {{ formatNumber(ex.amount) }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-slate-700 text-sm">NT$ {{ formatNumber(Math.round(ex.amount * (ex.currency === 'PHP' ? exchangeRate : 1))) }}</div>
                                <button @click="deleteExpense(ex.id)" class="text-[10px] text-red-300 hover:text-red-500 mt-1">Âà™Èô§</button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Tab 3: Âú∞Âúñ -->
            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map-container"></div>
                <div class="absolute bottom-24 right-4 flex flex-col gap-2 z-[400]">
                    <button @click="locateUser" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-teal-600 hover:bg-teal-50 border border-slate-100"><i data-lucide="crosshair" class="w-6 h-6"></i></button>
                    <button @click="fitBounds" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:bg-slate-50 border border-slate-100"><i data-lucide="maximize" class="w-6 h-6"></i></button>
                </div>
                <div class="absolute top-4 left-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg z-[400] border border-white/50 text-center">
                     <p class="text-xs text-slate-500"><span class="font-bold text-teal-600">{{ tripDays[currentDateIndex].dateShort }}</span> Ë°åÁ®ãÂú∞Âúñ</p>
                </div>
            </div>
        </main>

        <!-- Floating Add Button -->
        <button v-if="currentTab === 'schedule'" @click="showEventModal = true" class="absolute bottom-24 right-5 w-14 h-14 bg-teal-600 rounded-full shadow-float text-white flex items-center justify-center hover:bg-teal-700 hover:scale-105 transition-all z-40 active:scale-95">
            <i data-lucide="plus" class="w-7 h-7"></i>
        </button>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-slate-100 pb-8 pt-3 px-6 flex justify-between items-center z-50">
            <button v-for="tab in tabs" :key="tab.id" @click="switchTab(tab.id)" class="flex flex-col items-center gap-1 w-16 transition-all duration-300 relative" :class="currentTab === tab.id ? 'text-teal-600 -translate-y-1' : 'text-slate-300 hover:text-slate-400'">
                <div class="relative">
                    <i :data-lucide="tab.icon" class="w-6 h-6" :class="currentTab === tab.id ? 'fill-teal-50' : ''"></i>
                    <div v-if="currentTab === tab.id" class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1 h-1 bg-teal-600 rounded-full"></div>
                </div>
                <span class="text-[10px] font-medium">{{ tab.label }}</span>
            </button>
        </nav>

        <!-- Modals -->
        
        <!-- Add Event Modal -->
        <div v-if="showEventModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[1000] flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl animate-slide-up shadow-2xl">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold text-teal-900 mb-4">Êñ∞Â¢ûË°åÁ®ã</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3">
                        <input v-model="formEvent.time" type="time" class="col-span-1 input-field text-center font-bold">
                        <select v-model="formEvent.type" class="col-span-2 input-field bg-white">
                            <option value="spot">üì∏ ÊôØÈªû</option>
                            <option value="food">üçΩÔ∏è È§êÂª≥</option>
                            <option value="transport">üöó ‰∫§ÈÄö</option>
                            <option value="hotel">üè® ‰ΩèÂÆø</option>
                        </select>
                    </div>
                    <input v-model="formEvent.title" placeholder="Ê®ôÈ°å (‰æã: Ubeco ÂçàÈ§ê)" class="input-field">
                    <input v-model="formEvent.locationName" placeholder="Âú∞ÈªûÂêçÁ®±" class="input-field">
                    <input v-model="formEvent.tag" placeholder="Ê®ôÁ±§ (‰æã: 4.8‚≠ê)" class="input-field">
                    
                    <div class="pt-2">
                        <p class="text-xs text-slate-400 mb-2">Â∫ßÊ®ô (Áî®ÊñºÂú∞ÂúñÂÆö‰ΩçÔºåÂèØÈÅ∏Â°´)</p>
                        <div class="grid grid-cols-2 gap-2">
                            <input v-model.number="formEvent.lat" placeholder="Á∑ØÂ∫¶ Lat" class="input-field text-xs">
                            <input v-model.number="formEvent.lng" placeholder="Á∂ìÂ∫¶ Lng" class="input-field text-xs">
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showEventModal = false" class="flex-1 py-3 text-slate-400 font-bold text-sm rounded-xl hover:bg-slate-50 transition">ÂèñÊ∂à</button>
                    <button @click="saveEvent" class="flex-1 bg-teal-600 text-white rounded-xl py-3 font-bold shadow-lg shadow-teal-200 active:scale-95 transition">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>

        <!-- Add Expense Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[1000] flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl animate-slide-up shadow-2xl">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold text-teal-900 mb-4">Ë®ò‰∏ÄÁ≠Ü</h3>
                <div class="flex bg-slate-100 p-1 rounded-xl mb-4">
                    <button @click="formExpense.currency = 'TWD'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" :class="formExpense.currency === 'TWD' ? 'bg-white shadow-sm text-teal-600' : 'text-slate-400'">TWD (Âè∞Âπ£)</button>
                    <button @click="formExpense.currency = 'PHP'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" :class="formExpense.currency === 'PHP' ? 'bg-white shadow-sm text-teal-600' : 'text-slate-400'">PHP (Êä´Á¥¢)</button>
                </div>
                <div class="space-y-3">
                    <input v-model="formExpense.item" placeholder="È†ÖÁõÆ (‰æã: Grab)" class="input-field">
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-slate-400 font-bold text-sm">{{ formExpense.currency === 'TWD' ? '$' : '‚Ç±' }}</span>
                        <input v-model.number="formExpense.amount" type="number" placeholder="ÈáëÈ°ç" class="input-field pl-8 font-bold text-lg text-slate-700">
                    </div>
                    <div v-if="formExpense.currency === 'PHP'" class="text-xs text-right text-teal-500 font-medium px-1">‚âà NT$ {{ Math.round(formExpense.amount * exchangeRate) }}</div>
                    
                    <div class="text-xs text-slate-400 mb-2 ml-1 mt-4">Ë™∞ÂÖàÂ¢äÁöÑÈå¢Ôºü</div>
                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="m in members" :key="m" @click="formExpense.payer = m" class="py-2 rounded-xl text-xs font-bold border transition-all" :class="formExpense.payer === m ? 'bg-teal-50 border-teal-400 text-teal-700' : 'bg-white border-slate-100 text-slate-400'">{{ m }}</button>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 text-slate-400 font-bold text-sm rounded-xl hover:bg-slate-50 transition">ÂèñÊ∂à</button>
                    <button @click="saveExpense" class="flex-1 bg-teal-600 text-white rounded-xl py-3 font-bold shadow-lg shadow-teal-200 active:scale-95 transition">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
        
        <!-- Rate Modal -->
        <div v-if="showRateModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[1000] flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl">
                <h3 class="text-center font-bold text-slate-700 mb-4">Ë®≠ÂÆö PHP ÂåØÁéá</h3>
                <input v-model.number="exchangeRate" type="number" step="0.01" class="input-field text-center text-3xl font-bold text-teal-600 mb-6 py-4">
                <div class="flex gap-2">
                     <button @click="showRateModal = false" class="flex-1 py-3 text-slate-400 font-bold text-sm">ÂèñÊ∂à</button>
                     <button @click="saveRate" class="flex-1 bg-slate-800 text-white rounded-xl py-3 font-bold">Êõ¥Êñ∞</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const firebaseReady = ref(false);
                const dbInstance = ref(null);
                const fireOps = ref(null);

                // --- Initial Data (The "Normal" Itinerary) ---
                const initialItinerary = [
                    // Day 1: 2/11
                    { id: 'init-1', date: '2026-02-11', time: '12:15', title: 'ÊäµÈÅîÂÆøÈúß CEB', locationName: 'Mactan Airport', type: 'transport', lat: 10.308, lng: 123.979 },
                    { id: 'init-2', date: '2026-02-11', time: '15:00', title: 'Abaca Baking ÂçàÈ§ê', locationName: 'Ayala Center', type: 'food', tag: '4.4‚≠ê', lat: 10.317, lng: 123.905 },
                    { id: 'init-3', date: '2026-02-11', time: '18:30', title: 'The Pyramid ÊôöÈ§ê', locationName: 'IT Park', type: 'food', tag: '4.0‚≠ê', lat: 10.329, lng: 123.905 },
                    // Day 2: 2/12
                    { id: 'init-4', date: '2026-02-12', time: '09:00', title: 'Ocean Park', locationName: 'SM Seaside Area', type: 'spot', lat: 10.283, lng: 123.882 },
                    { id: 'init-5', date: '2026-02-12', time: '12:00', title: 'Aqua Dining', locationName: 'Êµ∑Â∫ïÈößÈÅìÊóÅ', type: 'food', tag: 'ÈúÄÈ†êÁ¥Ñ' },
                    { id: 'init-6', date: '2026-02-12', time: '18:00', title: 'Texas Roadhouse', locationName: 'SM Seaside', type: 'food', tag: '4.8‚≠ê', lat: 10.282, lng: 123.881 },
                    // Day 3: 2/13
                    { id: 'init-7', date: '2026-02-13', time: '11:40', title: 'Êê≠Ëàπ Ocean Jet', locationName: 'Cebu Pier 1', type: 'transport' },
                    { id: 'init-8', date: '2026-02-13', time: '15:00', title: 'Check-in', locationName: 'Best Western Alona', type: 'hotel', lat: 9.546, lng: 123.774 },
                    { id: 'init-9', date: '2026-02-13', time: '18:00', title: 'Giuseppe Pizzeria', locationName: 'Alona Beach Rd', type: 'food', tag: '4.3‚≠ê', lat: 9.549, lng: 123.775 },
                    // Day 4: 2/14
                    { id: 'init-10', date: '2026-02-14', time: '09:00', title: 'Napaling Reef', locationName: 'Ê≤ô‰∏ÅÈ≠öÈ¢®Êö¥', type: 'spot', lat: 9.605, lng: 123.770 },
                    { id: 'init-11', date: '2026-02-14', time: '11:30', title: 'Ubeco Á∂≤ÁæéÂçàÈ§ê', locationName: 'Panglao (ËøëÊôØÈªû)', type: 'food', tag: 'üèÜÈ¶ñÈÅ∏', lat: 9.6056, lng: 123.7742 },
                    { id: 'init-12', date: '2026-02-14', time: '13:30', title: 'Zipline / ATV', locationName: 'Bohol', type: 'spot' },
                    { id: 'init-13', date: '2026-02-14', time: '18:00', title: 'Mist Ê£ÆÊûóÁ≥ªÊôöÈ§ê', locationName: 'Danao/Alona', type: 'food', tag: 'ÈúÄË®Ç‰Ωç', lat: 9.554, lng: 123.766 },
                    // Day 5: 2/15
                    { id: 'init-14', date: '2026-02-15', time: '06:00', title: 'Âá∫Êµ∑ËøΩÊµ∑Ë±ö', locationName: 'Balicasag', type: 'spot', lat: 9.518, lng: 123.680 },
                    { id: 'init-15', date: '2026-02-15', time: '15:00', title: 'ÊèõÈ£ØÂ∫ó', locationName: 'Villa Kalachuchi', type: 'hotel', lat: 9.556, lng: 123.760 },
                    { id: 'init-16', date: '2026-02-15', time: '18:00', title: 'Luna Rossa', locationName: 'Á¥†È£üÁæ©Â§ßÂà©Ëèú', type: 'food', tag: 'Ê∏ÖÁàΩ', lat: 9.553, lng: 123.762 },
                    // Day 6: 2/16
                    { id: 'init-17', date: '2026-02-16', time: '09:00', title: 'Â∑ßÂÖãÂäõÂ±±', locationName: 'Chocolate Hills', type: 'spot', lat: 9.829, lng: 124.139 },
                    { id: 'init-18', date: '2026-02-16', time: '18:00', title: 'Bohol Bee Farm', locationName: 'Êá∏Â¥ñÊµ∑ÊôØ', type: 'food', tag: 'ÊúâÊ©ü', lat: 9.576, lng: 123.821 },
                    // Day 7: 2/17
                    { id: 'init-19', date: '2026-02-17', time: '13:00', title: 'Êê≠ËàπÂõûÂÆøÈúß', locationName: 'Tagbilaran Port', type: 'transport' },
                    { id: 'init-20', date: '2026-02-17', time: '18:35', title: 'È£õÂæÄÈ¶¨Â∞ºÊãâ', locationName: 'CEB -> MNL', type: 'transport' },
                    { id: 'init-21', date: '2026-02-17', time: '20:30', title: 'Shake Shack', locationName: 'BGC', type: 'food', tag: 'Á∞°ÂñÆÂêÉ', lat: 14.550, lng: 121.050 },
                    // Day 8: 2/18
                    { id: 'init-22', date: '2026-02-18', time: '10:00', title: 'Mind Museum', locationName: 'BGC', type: 'spot', lat: 14.551, lng: 121.045 },
                    { id: 'init-23', date: '2026-02-18', time: '12:00', title: 'Mamou Meats', locationName: 'Uptown', type: 'food', tag: 'üèÜ5.0‚≠ê', lat: 14.557, lng: 121.054 },
                ];

                const tabs = [{ id: 'schedule', label: 'Ë°åÁ®ã', icon: 'calendar' }, { id: 'money', label: 'ÂàÜÂ∏≥', icon: 'wallet' }, { id: 'map', label: 'Âú∞Âúñ', icon: 'map' }];
                const members = ['Áà∏Áà∏', 'Â™ΩÂ™Ω', 'ÈòøÂ¨§', 'Remi'];
                const tripDays = [
                    { date: '2026-02-11', dateShort: '2/11', dayShort: 'Tue', dayName:'ÈÄ±‰∫å', dayNum: '11' }, { date: '2026-02-12', dateShort: '2/12', dayShort: 'Wed', dayName:'ÈÄ±‰∏â', dayNum: '12' },
                    { date: '2026-02-13', dateShort: '2/13', dayShort: 'Thu', dayName:'ÈÄ±Âõõ', dayNum: '13' }, { date: '2026-02-14', dateShort: '2/14', dayShort: 'Fri', dayName:'ÈÄ±‰∫î', dayNum: '14' },
                    { date: '2026-02-15', dateShort: '2/15', dayShort: 'Sat', dayName:'ÈÄ±ÂÖ≠', dayNum: '15' }, { date: '2026-02-16', dateShort: '2/16', dayShort: 'Sun', dayName:'ÈÄ±Êó•', dayNum: '16' },
                    { date: '2026-02-17', dateShort: '2/17', dayShort: 'Mon', dayName:'ÈÄ±‰∏Ä', dayNum: '17' }, { date: '2026-02-18', dateShort: '2/18', dayShort: 'Tue', dayName:'ÈÄ±‰∫å', dayNum: '18' }
                ];

                const currentTab = ref('schedule');
                const currentDateIndex = ref(0);
                const showEventModal = ref(false);
                const showExpenseModal = ref(false);
                const showRateModal = ref(false);
                const exchangeRate = ref(0.56);
                const itinerary = ref([]);
                const expenses = ref([]);

                const formEvent = ref({ time: '12:00', title: '', locationName: '', type: 'food', tag: '', lat: null, lng: null });
                const formExpense = ref({ item: '', amount: '', currency: 'PHP', payer: 'Áà∏Áà∏' });

                let map = null, markersLayer = null, pathLayer = null;

                const initFirebaseListeners = async () => {
                    const { collection, onSnapshot, query, orderBy, addDoc, getDocs } = fireOps.value;
                    const db = dbInstance.value;

                    // --- First time check: Populate data if empty ---
                    const evColl = collection(db, "events");
                    const snapshotCheck = await getDocs(evColl);
                    if (snapshotCheck.empty) {
                        console.log("Empty DB, populating initial itinerary...");
                        for (const item of initialItinerary) {
                            await addDoc(evColl, item);
                        }
                    }

                    // Listen to Itinerary
                    const qItinerary = query(collection(db, "events")); 
                    onSnapshot(qItinerary, (snapshot) => {
                        itinerary.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        fetchWeather(); 
                        if (currentTab.value === 'map') updateMapMarkers();
                    });

                    // Listen to Expenses
                    const qExpenses = query(collection(db, "expenses"));
                    onSnapshot(qExpenses, (snapshot) => {
                        expenses.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                };

                const saveEvent = async () => {
                    const { addDoc, collection } = fireOps.value;
                    await addDoc(collection(dbInstance.value, "events"), {
                        ...formEvent.value,
                        date: tripDays[currentDateIndex.value].date,
                        weather: null,
                        createdAt: new Date()
                    });
                    showEventModal.value = false;
                };

                const deleteEvent = async (id) => {
                    if(!confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) return;
                    const { deleteDoc, doc } = fireOps.value;
                    await deleteDoc(doc(dbInstance.value, "events", id));
                };

                const saveExpense = async () => {
                    const { addDoc, collection } = fireOps.value;
                    await addDoc(collection(dbInstance.value, "expenses"), {
                        ...formExpense.value,
                        createdAt: new Date()
                    });
                    showExpenseModal.value = false;
                    formExpense.value = { item: '', amount: '', currency: 'PHP', payer: 'Áà∏Áà∏' };
                };

                const deleteExpense = async (id) => {
                    if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÁ≠ÜÂ∏≥Ôºü')) return;
                    const { deleteDoc, doc } = fireOps.value;
                    await deleteDoc(doc(dbInstance.value, "expenses", id));
                };

                const saveRate = () => {
                    showRateModal.value = false;
                    alert("ÂåØÁéáÂ∑≤Êõ¥Êñ∞ÔºÅ");
                };

                const initMap = () => {
                    if (map) return;
                    map = L.map('map-container', { zoomControl: false }).setView([10.3157, 123.8854], 12);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                    markersLayer = L.layerGroup().addTo(map);
                    pathLayer = L.layerGroup().addTo(map);
                    updateMapMarkers();
                };

                const updateMapMarkers = () => {
                    if (!map || !markersLayer) return;
                    markersLayer.clearLayers();
                    pathLayer.clearLayers();
                    const events = currentDayEvents.value.filter(e => e.lat && e.lng);
                    if (events.length === 0) return;
                    const latlngs = [];
                    events.forEach((e, idx) => {
                        const point = [e.lat, e.lng];
                        latlngs.push(point);
                        const icon = L.divIcon({ className: 'custom-div-icon', html: idx + 1, iconSize: [24, 24] });
                        L.marker(point, { icon }).bindPopup(e.title).addTo(markersLayer);
                    });
                    if (latlngs.length > 1) L.polyline(latlngs, { color: '#14b8a6', dashArray: '5, 10', weight: 3 }).addTo(pathLayer);
                    const bounds = L.latLngBounds(latlngs);
                    map.fitBounds(bounds, { padding: [50, 50] });
                };

                const locateUser = () => {
                    if (!map) return;
                    map.locate({ setView: true, maxZoom: 14 });
                    map.on('locationfound', (e) => {
                        L.circleMarker(e.latlng, { radius: 8, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 1 }).bindPopup("‰Ω†Âú®ÈÄôË£°").addTo(map).openPopup();
                    });
                };
                const fitBounds = () => updateMapMarkers();

                const currentDayEvents = computed(() => {
                    const date = tripDays[currentDateIndex.value].date;
                    return itinerary.value.filter(e => e.date === date).sort((a,b) => a.time.localeCompare(b.time));
                });
                
                const totalExpenseTwd = computed(() => expenses.value.reduce((sum, ex) => sum + (ex.amount * (ex.currency === 'PHP' ? exchangeRate.value : 1)), 0));
                
                const balances = computed(() => {
                    const perPerson = totalExpenseTwd.value / members.length;
                    const result = {};
                    members.forEach(m => result[m] = -perPerson);
                    expenses.value.forEach(ex => result[ex.payer] += (ex.amount * (ex.currency === 'PHP' ? exchangeRate.value : 1)));
                    return result;
                });

                const fetchWeather = async () => {
                     itinerary.value.forEach(async (ev) => {
                        if (!ev.lat || !ev.lng || ev.weather) return;
                        try {
                            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${ev.lat}&longitude=${ev.lng}&current_weather=true`);
                            const data = await res.json();
                            ev.weather = { temp: data.current_weather.temperature, code: data.current_weather.weathercode };
                        } catch(e) {}
                    });
                };
                
                const getWeatherIcon = (code) => code <= 3 ? 'sun' : 'cloud';
                const hasEvent = (date) => itinerary.value.some(e => e.date === date);
                const getTypeName = (type) => ({'food':'È§êÂª≥', 'spot':'ÊôØÈªû', 'transport':'‰∫§ÈÄö', 'hotel':'‰ΩèÂÆø'})[type] || 'ÂÖ∂‰ªñ';
                const getAvatar = (name) => ({ 'Áà∏Áà∏': 'üë®üèª', 'Â™ΩÂ™Ω': 'üë©üèª', 'ÈòøÂ¨§': 'üëµüèª', 'Remi': 'üëßüèª' })[name] || 'üë§';
                const formatNumber = (num) => new Intl.NumberFormat().format(Math.round(num));

                const changeDate = (idx) => { currentDateIndex.value = idx; if(currentTab.value === 'map') setTimeout(updateMapMarkers, 300); };
                const switchTab = (tabId) => {
                    currentTab.value = tabId;
                    if(tabId === 'map') nextTick(() => { if(!map) initMap(); else { map.invalidateSize(); updateMapMarkers(); } });
                };
                const openMapForEvent = (event) => { switchTab('map'); setTimeout(() => { if(event.lat) { map.setView([event.lat, event.lng], 16); L.popup().setLatLng([event.lat, event.lng]).setContent(event.title).openOn(map); } }, 500); };

                window.addEventListener('firebase-ready', () => {
                    dbInstance.value = window.db;
                    fireOps.value = window.firestoreOps;
                    initFirebaseListeners();
                    firebaseReady.value = true;
                });

                onMounted(() => { lucide.createIcons(); });
                watch(currentTab, () => nextTick(() => lucide.createIcons()));

                return {
                    firebaseReady, tabs, currentTab, switchTab, tripDays, currentDateIndex, changeDate, hasEvent,
                    currentDayEvents, expenses, totalExpenseTwd, balances, members, exchangeRate,
                    showEventModal, showExpenseModal, showRateModal, formEvent, formExpense,
                    saveEvent, deleteEvent, saveExpense, deleteExpense, saveRate,
                    getAvatar, getWeatherIcon, getTypeName, formatNumber, openMapForEvent, locateUser, fitBounds
                };
            }
        }).mount('#app');
    </script>
    <style>
        .input-field { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; font-size: 14px; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #2dd4bf; background-color: white; box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1); }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</body>
</html>
