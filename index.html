   { id: '4-5', date: '2026-02-14', time: '18:00', title: '晚餐 Mist', locationName: '森林系餐廳', type: 'food', tag: '推薦', lat: 9.554, lng: 123.766 },
                    { id: '5-0', date: '2026-02-15', time: '06:00', title: '跳島一日遊', locationName: 'Balicasag', type: 'spot', tag: '包船', lat: 9.518, lng: 123.680 },
                    { id: '5-2', date: '2026-02-15', time: '11:00', title: 'Virgin Island', locationName: '處女島', type: 'spot', lat: 9.556, lng: 123.730 },
                    { id: '5-4', date: '2026-02-15', time: '14:30', title: 'Check in Villa', locationName: 'Villa Kalachuchi (Danao)', type: 'hotel', note: '無早餐有廚房', lat: 9.556, lng: 123.760 },
                    { id: '5-5', date: '2026-02-15', time: '18:00', title: '晚餐 Luna Rossa', locationName: '素食義大利菜', type: 'food', tag: '推薦', lat: 9.553, lng: 123.762 },
                    { id: '6-0', date: '2026-02-16', time: '09:00', title: '包車一日遊', locationName: 'Bohol 內陸', type: 'transport', tag: '6500p', lat: 9.696, lng: 124.120 },
                    { id: '6-2', date: '2026-02-16', time: '10:00', title: '眼鏡猴 & 人造林', locationName: 'Tarsier Area', type: 'spot', lat: 9.696, lng: 124.120 },
                    { id: '6-3', date: '2026-02-16', time: '12:00', title: '午餐 Rio Verde', locationName: '漂流竹筏', type: 'food', lat: 9.623, lng: 124.019 },
                    { id: '6-4', date: '2026-02-16', time: '14:00', title: '巧克力山', locationName: 'Chocolate Hills', type: 'spot', lat: 9.829, lng: 124.139 },
                    { id: '6-6', date: '2026-02-16', time: '18:00', title: '晚餐 Bohol Bee Farm', locationName: '海景懸崖', type: 'food', tag: '必吃', lat: 9.576, lng: 123.821 },
                    { id: '7-1', date: '2026-02-17', time: '11:00', title: 'South Farm', locationName: '動物農場', type: 'spot', lat: 9.569, lng: 123.789 },
                    { id: '7-4', date: '2026-02-17', time: '15:30', title: '前往邦勞機場', locationName: 'Panglao Airport', type: 'transport', lat: 9.565, lng: 123.763 },
                    { id: '7-5', date: '2026-02-17', time: '18:20', title: '飛往馬尼拉 5J616', locationName: 'TAG -> MNL', type: 'transport', lat: 14.512, lng: 121.015 },
                    { id: '7-6', date: '2026-02-17', time: '21:30', title: '晚餐 Shake Shack', locationName: 'BGC', type: 'food', tag: '簡單吃', lat: 14.550, lng: 121.050 },
                    { id: '7-7', date: '2026-02-17', time: '22:00', title: '入住 Uptown', locationName: 'Uptown Parksuites', type: 'hotel', lat: 14.557, lng: 121.054 },
                    { id: '8-0', date: '2026-02-18', time: '09:00', title: 'Wildflour Cafe', locationName: 'Uptown', type: 'food', tag: '早餐推薦', lat: 14.552, lng: 121.047 },
                    { id: '8-1', date: '2026-02-18', time: '10:00', title: 'Mind Museum', locationName: '科學館', type: 'spot', lat: 14.551, lng: 121.045 },
                    { id: '8-2', date: '2026-02-18', time: '12:00', title: '午餐 Mamou Meats', locationName: 'Uptown', type: 'food', tag: '推薦', lat: 14.557, lng: 121.054 },
                    { id: '8-3', date: '2026-02-18', time: '19:00', title: '前往機場', locationName: 'MNL T3', type: 'transport', lat: 14.512, lng: 121.015 },
                    { id: '8-4', date: '2026-02-18', time: '23:35', title: '返台 5J310', locationName: 'MNL -> TPE', type: 'transport' }
                ];

                const loadFromLocal = () => {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : { events: [...initialItinerary], shopping: [] };
                };
                const localData = loadFromLocal();
                const events = ref(localData.events);
                const shoppingList = ref(localData.shopping);

                const saveToLocal = () => {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({ 
                        events: events.value,
                        shopping: shoppingList.value
                    }));
                };

                const resetToDefault = () => {
                    if(confirm('重置？')) { 
                        events.value = [...initialItinerary]; 
                        shoppingList.value = [];
                        saveToLocal(); 
                        location.reload(); 
                    }
                };

                const currentDayEvents = computed(() => {
                    const targetDate = tripDays[currentDateIndex.value].date;
                    return events.value.filter(e => e.date === targetDate).sort((a,b) => a.time.localeCompare(b.time));
                });
                
                const currentCity = computed(() => currentDateIndex.value < 2 ? 'Cebu' : currentDateIndex.value <= 5 ? 'Bohol' : 'Manila');
                const currentWeather = computed(() => ({ temp: 30, feels_like: 34, icon: 'sun' }));
                const calcTWD = computed(() => { const v = parseFloat(calcPHP.value); return isNaN(v) ? 0 : Math.round(v * 0.56); });

                const changeDate = (idx) => { currentDateIndex.value = idx; fetchWeather(); };
                
                const openGoogleMap = (e) => {
                    // 優先使用輸入的地址，其次地點名稱
                    const q = e.address || e.locationName || e.title;
                    if(q) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
                };
                
                const openPopup = (t) => activePopup.value = t;
                const closePopup = () => activePopup.value = null;
                const openAddModal = () => { 
                    formEvent.value = { date: tripDays[currentDateIndex.value].date, time: '12:00', type: 'spot', title: '', locationName: '', address: '', note: '' }; 
                    showEventModal.value = true; 
                };
                
                const saveEvent = () => { 
                    events.value.push({...formEvent.value, id: Date.now()}); 
                    saveToLocal(); 
                    showEventModal.value = false; 
                };
                
                const addShopping = () => {
                    if(!formShopping.value.name) return;
                    shoppingList.value.push({ ...formShopping.value, id: Date.now() });
                    formShopping.value = { name: '' };
                    saveToLocal();
                };

                const deleteItem = (type, idx) => {
                     if(type === 'shopping') shoppingList.value.splice(idx, 1);
                     saveToLocal();
                };

                const deleteEvent = (id) => { if(confirm('確定刪除？')) { events.value = events.value.filter(i => i.id !== id); saveToLocal(); }};
                
                // Weather
                const weather = ref({ temp: '--', feels_like: '--', rainProb: '--', icon: 'sun', isRainy: false });
                const fetchWeather = async () => {
                    const d = tripDays[currentDateIndex.value];
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${d.lat}&longitude=${d.lng}&current=temperature_2m,apparent_temperature,precipitation,weather_code,is_day&daily=precipitation_probability_max&timezone=auto`);
                        const data = await res.json();
                        const code = data.current.weather_code;
                        const isRain = code >= 51;
                        weather.value = {
                            temp: Math.round(data.current.temperature_2m),
                            feels_like: Math.round(data.current.apparent_temperature),
                            rainProb: data.daily.precipitation_probability_max[0],
                            icon: isRain ? 'cloud-rain' : (code <= 3 ? 'sun' : 'cloud'),
                            isRainy: isRain
                        };
                    } catch(e) {}
                };

                // Map Logic
                let map = null;
                let markersLayer = null;

                const forceInitMap = () => {
                     if (map) { map.off(); map.remove(); map = null; }
                     setTimeout(() => {
                         const el = document.getElementById('map-container');
                         if(!el) return;
                         map = L.map(el, { zoomControl: false }).setView([10.3157, 123.8854], 12);
                         L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                         markersLayer = L.layerGroup().addTo(map);
                         updateMapMarkers();
                     }, 200);
                };

                const updateMapMarkers = () => {
                    if (!map || !markersLayer) return;
                    markersLayer.clearLayers();
                    const dayEvents = events.value.filter(e => e.date === tripDays[currentDateIndex.value].date && e.lat && e.lng);
                    if (dayEvents.length > 0) {
                        const latlngs = [];
                        dayEvents.forEach((e, idx) => {
                            const point = [e.lat, e.lng];
                            latlngs.push(point);
                            const icon = L.divIcon({ className: 'custom-div-icon', html: idx + 1, iconSize: [24, 24] });
                            L.marker(point, { icon }).bindPopup(e.title).addTo(markersLayer);
                        });
                        map.fitBounds(L.latLngBounds(latlngs), { padding: [50, 50] });
                    }
                };
                const locateUser = () => map && map.locate({ setView: true, maxZoom: 14 });
                const fitBounds = () => updateMapMarkers();

                const switchTab = (tabId) => {
                    currentTab.value = tabId;
                    if(tabId === 'map') forceInitMap();
                };

                // Helpers
                const getCategoryName = (c) => ({ spot: '景點', food: '美食', hotel: '住宿', transport: '交通', note: '筆記', activity: '活動' })[c] || '其他';
                const getCategoryColor = (c) => ({ spot: 'bg-teal-500', food: 'bg-amber-400', hotel: 'bg-indigo-500', transport: 'bg-sky-500', note: 'bg-rose-400' })[c] || 'bg-slate-400';
                const getCategoryIcon = (c) => ({ spot: 'camera', food: 'utensils', hotel: 'bed', transport: 'car', note: 'file-text' })[c] || 'circle';
                const getCategoryBadgeStyle = (c) => ({ spot: 'bg-teal-50 text-teal-600 border-teal-200', food: 'bg-amber-50 text-amber-600 border-amber-200' })[c] || 'bg-slate-50 text-slate-500 border-slate-200';

                // Init
                onMounted(() => { 
                    lucide.createIcons();
                    fetchWeather();
                });
                
                watch([currentTab, currentDateIndex, activePopup], () => {
                    nextTick(() => lucide.createIcons());
                    if(currentTab.value === 'map') forceInitMap();
                });

                return {
                    currentTab, activePopup, currentDateIndex, currentDayEvents, tripDays, changeDate, openGoogleMap, switchTab,
                    saveEvent, deleteEvent, openPopup, closePopup, openAddModal, initMap: forceInitMap, locateUser, fitBounds,
                    getCategoryName, getCategoryColor, getCategoryBadgeStyle, getCategoryIcon, currentWeather, currentCity, 
                    calcPHP, calcTWD, showEventModal, formEvent, resetToDefault,
                    shoppingList, formShopping, addShopping, deleteItem
                };
            }
        }).mount('#app');
    </script>
    <style>
        .input-full { @apply w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all; }
        .btn-full { width: 100%; background: #0D9488; color: white; font-weight: bold; padding: 12px; border-radius: 12px; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 4px; box-shadow: 0 4px 6px rgba(13, 148, 136, 0.2); }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .popup-enter-active, .popup-leave-active { transition: all 0.3s ease; }
        .popup-enter-from, .popup-leave-to { opacity: 0; transform: translateY(20px); }
        .popup-input-area { background: #F0FDFA; border-bottom: 1px solid #CCFBF1; padding: 16px; position: sticky; top: 0; z-index: 20; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        /* Timeline line fix */
        .timeline-line {
            position: absolute; left: 23px; top: 40px; bottom: -24px;
            width: 2px; border-left: 2px dashed #CBD5E1; z-index: 0;
        }
    </style>
</body>
</html>

