<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's Family Trip ‚òÅÔ∏è</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase Ë®≠ÂÆö -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA1JHrkPbANS-g7X8OudpD0w819ZXA8-7A",
            authDomain: "family-trip-2026-1c43d.firebaseapp.com",
            projectId: "family-trip-2026-1c43d",
            storageBucket: "family-trip-2026-1c43d.firebasestorage.app",
            messagingSenderId: "157512457202",
            appId: "1:157512457202:web:b211df6298c0057e62e96b",
            measurementId: "G-LDQW10LQZ4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firestoreOps = { collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, getDocs };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- Â≠óÈ´îËàáÊ®£Âºè -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { teal: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 900: '#134e4a' } },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    boxShadow: { 'float': '0 10px 30px -10px rgba(20, 184, 166, 0.3)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        #map-container { height: 100%; width: 100%; z-index: 0; }
        .custom-div-icon { background: #14b8a6; color: white; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-600 font-sans">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto bg-slate-50 relative shadow-2xl">

        <!-- Loading -->
        <div v-if="!firebaseReady" class="absolute inset-0 z-[9999] bg-white flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-teal-200 border-t-teal-500 rounded-full animate-spin mb-4"></div>
            <p class="text-teal-600 font-bold animate-pulse">Ê≠£Âú®ËÆÄÂèñÈõ≤Á´ØË°åÁ®ã...</p>
        </div>

        <!-- Header -->
        <header class="px-5 pt-12 pb-3 bg-white/95 backdrop-blur-md z-30 sticky top-0 border-b border-slate-100 shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h1 class="text-xl font-bold text-teal-900 tracking-tight">Remi Family Trip</h1>
                    <p class="text-xs text-slate-400 mt-0.5">6Â§ß1Â∞è ‚Ä¢ ÂÆøÈúßËñÑËç∑Â≥∂ 8Êó•ÈÅä</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-teal-50 flex items-center justify-center text-lg border border-teal-100 shadow-sm">
                    üëßüèª
                </div>
            </div>

            <!-- Date Scroller (Anchor Links) -->
            <div v-if="currentTab === 'schedule'" class="flex space-x-2 overflow-x-auto hide-scrollbar pb-1">
                <button v-for="(day, index) in tripDays" :key="index" @click="scrollToDay(day.date)"
                    class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all duration-300 border relative overflow-hidden bg-white text-slate-500 border-slate-100 hover:border-teal-300 active:scale-95">
                    <span class="text-[10px] opacity-80 uppercase font-medium">{{ day.dayShort }}</span>
                    <span class="text-lg font-bold">{{ day.dayNum }}</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative bg-slate-50 hide-scrollbar scroll-smooth" id="main-scroll">
            
            <!-- Tab 1: Schedule (Long Scroll) -->
            <transition name="fade">
                <div v-if="currentTab === 'schedule'" class="px-4 py-6 space-y-8 pb-32">
                    
                    <div v-if="itinerary.length === 0" class="flex flex-col items-center justify-center py-20 text-slate-300 opacity-60">
                        <i data-lucide="coffee" class="w-12 h-12 mb-3 stroke-1"></i>
                        <p class="text-sm font-medium">ËÆÄÂèñ‰∏≠...</p>
                        <button @click="forceInit" class="mt-4 text-teal-600 text-xs font-bold border border-teal-200 px-4 py-2 rounded-full hover:bg-teal-50">ÈáçÊñ∞ËºâÂÖ•</button>
                    </div>

                    <!-- Day Groups -->
                    <div v-for="(day, dayIdx) in tripDays" :key="day.date" :id="'day-' + day.date" class="scroll-mt-40">
                        
                        <!-- Day Header -->
                        <div class="flex items-center gap-3 mb-4 sticky top-0 bg-slate-50/95 py-2 z-10">
                            <div class="px-3 py-1 bg-teal-600 text-white rounded-lg text-sm font-bold shadow-md">
                                Day {{ dayIdx + 1 }}
                            </div>
                            <div class="text-sm font-bold text-slate-700">
                                {{ day.dateShort }} ({{ day.dayName }})
                            </div>
                            <div class="h-[1px] flex-1 bg-slate-200"></div>
                        </div>

                        <!-- Events for this day -->
                        <div class="space-y-4">
                            <div v-for="event in getEventsForDay(day.date)" :key="event.id" 
                                 class="group bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex gap-4 relative overflow-hidden transition-all hover:shadow-md">
                                
                                <!-- Side Color -->
                                <div class="absolute left-0 top-0 bottom-0 w-1 transition-colors" :class="getTypeColor(event.type)"></div>
                                
                                <!-- Time -->
                                <div class="flex flex-col items-center min-w-[3.5rem] pt-0.5 border-r border-slate-50 pr-3">
                                    <span class="text-lg font-bold text-slate-700 font-sans tracking-tight">{{ event.time }}</span>
                                    <div v-if="event.weather" class="mt-2 text-xs flex flex-col items-center text-amber-500 bg-amber-50 px-1 py-0.5 rounded">
                                        <i :data-lucide="getWeatherIcon(event.weather.code)" class="w-3 h-3 mb-0.5"></i>
                                        <span class="scale-90 font-bold">{{ event.weather.temp }}¬∞</span>
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-bold text-slate-800 text-base leading-tight truncate pr-2">{{ event.title }}</h3>
                                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="openMapForEvent(event)" class="text-slate-300 hover:text-teal-500"><i data-lucide="map" class="w-4 h-4"></i></button>
                                            <button @click="deleteEvent(event.id)" class="text-slate-300 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    
                                    <p class="text-xs text-slate-400 mt-1 flex items-center">
                                        <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> {{ event.locationName }}
                                    </p>
                                    
                                    <!-- Tags -->
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <span class="px-2 py-0.5 rounded-md text-[10px] font-bold border"
                                            :class="getTypeStyle(event.type)">
                                            {{ getTypeName(event.type) }}
                                        </span>
                                        <span v-if="event.tag" class="px-2 py-0.5 bg-slate-50 text-slate-500 rounded-md text-[10px] border border-slate-100 flex items-center">
                                            <i data-lucide="star" class="w-2 h-2 mr-1 text-orange-400 fill-orange-400"></i> {{ event.tag }}
                                        </span>
                                        <span v-if="event.type === 'note'" class="px-2 py-0.5 bg-red-50 text-red-500 rounded-md text-[10px] border border-red-100 flex items-center">
                                            <i data-lucide="alert-circle" class="w-2 h-2 mr-1"></i> ÈáçË¶Å
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Empty day placeholder -->
                            <div v-if="getEventsForDay(day.date).length === 0" class="text-center py-4 text-xs text-slate-300 border-2 border-dashed border-slate-100 rounded-xl">
                                Êú¨Êó•Â∞öÁÑ°Ë°åÁ®ã
                            </div>
                        </div>
                    </div>

                </div>
            </transition>

            <!-- Tab 2: Map -->
            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map-container"></div>
                <div class="absolute bottom-24 right-4 flex flex-col gap-2 z-[400]">
                    <button @click="locateUser" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-teal-600 hover:bg-teal-50 border border-slate-100"><i data-lucide="crosshair" class="w-6 h-6"></i></button>
                    <button @click="fitBounds" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:bg-slate-50 border border-slate-100"><i data-lucide="maximize" class="w-6 h-6"></i></button>
                </div>
            </div>
        </main>

        <!-- Floating Add Button -->
        <button v-if="currentTab === 'schedule'" @click="showEventModal = true" class="absolute bottom-24 right-5 w-14 h-14 bg-teal-600 rounded-full shadow-float text-white flex items-center justify-center hover:bg-teal-700 hover:scale-105 transition-all z-40 active:scale-95">
            <i data-lucide="plus" class="w-7 h-7"></i>
        </button>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-slate-100 pb-8 pt-3 px-6 flex justify-around items-center z-50">
            <button v-for="tab in tabs" :key="tab.id" @click="switchTab(tab.id)" class="flex flex-col items-center gap-1 w-16 transition-all duration-300 relative" :class="currentTab === tab.id ? 'text-teal-600 -translate-y-1' : 'text-slate-300 hover:text-slate-400'">
                <div class="relative">
                    <i :data-lucide="tab.icon" class="w-6 h-6" :class="currentTab === tab.id ? 'fill-teal-50' : ''"></i>
                    <div v-if="currentTab === tab.id" class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1 h-1 bg-teal-600 rounded-full"></div>
                </div>
                <span class="text-[10px] font-medium">{{ tab.label }}</span>
            </button>
        </nav>

        <!-- Event Modal -->
        <div v-if="showEventModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[1000] flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl animate-slide-up shadow-2xl">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold text-teal-900 mb-4">Êñ∞Â¢ûË°åÁ®ã</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3">
                        <input v-model="formEvent.time" type="time" class="col-span-1 input-field text-center font-bold">
                        <select v-model="formEvent.type" class="col-span-2 input-field bg-white">
                            <option value="spot">üì∏ ÊôØÈªû</option>
                            <option value="food">üçΩÔ∏è È§êÂª≥</option>
                            <option value="transport">üöó ‰∫§ÈÄö</option>
                            <option value="hotel">üè® ‰ΩèÂÆø</option>
                            <option value="note">‚ö†Ô∏è ÂÇôË®ª</option>
                        </select>
                    </div>
                    
                    <!-- Êó•ÊúüÈÅ∏Êìá -->
                    <select v-model="formEvent.date" class="input-field bg-white">
                        <option v-for="day in tripDays" :key="day.date" :value="day.date">
                            {{ day.dateShort }} ({{ day.dayName }})
                        </option>
                    </select>

                    <input v-model="formEvent.title" placeholder="Ê®ôÈ°å" class="input-field">
                    <input v-model="formEvent.locationName" placeholder="Âú∞ÈªûÂêçÁ®±" class="input-field">
                    <input v-model="formEvent.tag" placeholder="Ê®ôÁ±§ (‰æã: 4.8‚≠ê)" class="input-field">
                    
                    <div class="pt-2">
                        <p class="text-xs text-slate-400 mb-2">Â∫ßÊ®ô (ÈÅ∏Â°´)</p>
                        <div class="grid grid-cols-2 gap-2">
                            <input v-model.number="formEvent.lat" placeholder="Á∑ØÂ∫¶ Lat" class="input-field text-xs">
                            <input v-model.number="formEvent.lng" placeholder="Á∂ìÂ∫¶ Lng" class="input-field text-xs">
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showEventModal = false" class="flex-1 py-3 text-slate-400 font-bold text-sm rounded-xl hover:bg-slate-50 transition">ÂèñÊ∂à</button>
                    <button @click="saveEvent" class="flex-1 bg-teal-600 text-white rounded-xl py-3 font-bold shadow-lg shadow-teal-200 active:scale-95 transition">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const firebaseReady = ref(false);
                const dbInstance = ref(null);
                const fireOps = ref(null);

                // --- Initial Data (ÂÆåÊï¥ 8 Â§©Ë©≥Á¥∞Ë°åÁ®ã) ---
                const initialItinerary = [
                    // Day 1: 2/11
                    { id: '1-0', date: '2026-02-11', time: '03:15', title: '5J311 È£õÂæÄÈ¶¨Â∞ºÊãâ', locationName: 'TPE T1 -> MNL T3', type: 'transport', tag: 'ËΩâÊ©ü' },
                    { id: '1-1', date: '2026-02-11', time: '05:45', title: 'ÊäµÈÅîÈ¶¨Â∞ºÊãâ T3', locationName: 'MNL T3', type: 'note', tag: 'ÈúÄÈ†òË°åÊùé' },
                    { id: '1-1-b', date: '2026-02-11', time: '07:00', title: 'Ê©üÂ†¥Êó©È§ê', locationName: 'MNL T3 ÁæéÈ£üË°ó', type: 'food', tag: 'Jollibee' },
                    { id: '1-2', date: '2026-02-11', time: '10:50', title: '5J585 È£õÂæÄÂÆøÈúß', locationName: 'MNL T3 -> CEB', type: 'transport' },
                    { id: '1-3', date: '2026-02-11', time: '12:00', title: 'ÊäµÈÅîÂÆøÈúß & Grab', locationName: 'Mactan Airport', type: 'transport', tag: 'Âè´Ëªä' },
                    { id: '1-4', date: '2026-02-11', time: '13:00', title: 'È£ØÂ∫ó Check-in', locationName: 'ÂÆøÂãôÊ¥æÂÖãËò≠ÂúãÈöõÂ§ßÈ£ØÂ∫ó', type: 'hotel', lat: 10.317, lng: 123.903 },
                    { id: '1-5', date: '2026-02-11', time: '14:00', title: 'Mall ÈôÑËøëÊèõÈå¢', locationName: 'Ayala Center Cebu', type: 'activity', tag: 'ÂåØÁéá‰Ω≥' },
                    { id: '1-6', date: '2026-02-11', time: '15:00', title: 'ÂçàÈ§ê Mall (Kuya J / House of Lechon)', locationName: 'Ayala Center', type: 'food', tag: 'Êé®Ëñ¶' },
                    { id: '1-7', date: '2026-02-11', time: '18:00', title: 'Â§úÂ∏Ç (Sugbo Mercado)', locationName: 'IT Park', type: 'food', tag: 'ÊôöÈ§ê' },

                    // Day 2: 2/12
                    { id: '2-0', date: '2026-02-12', time: '07:30', title: 'È£ØÂ∫óÊó©È§ê', locationName: 'Parklane Hotel', type: 'food' },
                    { id: '2-1', date: '2026-02-12', time: '09:00', title: 'ÊäµÈÅî Cebu Ocean Park', locationName: 'SM Seaside ÊóÅ', type: 'spot', lat: 10.283, lng: 123.882 },
                    { id: '2-2', date: '2026-02-12', time: '10:00', title: 'Grab ÁßªÂãï', locationName: '', type: 'transport' },
                    { id: '2-3', date: '2026-02-12', time: '11:00', title: 'Ê∞¥ÊóèÈ§®Á∂≤ÁæéÈ§ê (Aqua Dining)', locationName: 'Êµ∑Â∫ïÈößÈÅìÊóÅ', type: 'food', tag: 'ÈúÄÈ†êÁ¥Ñ' },
                    { id: '2-4', date: '2026-02-12', time: '12:00', title: 'SM Seaside Mall ÈÄõË°ó', locationName: 'Blackbeard Seafood', type: 'activity' },
                    { id: '2-5', date: '2026-02-12', time: '13:00', title: 'È∫•Âì≤ÂÄ´ÂçÅÂ≠óÊû∂', locationName: 'Magellans Cross', type: 'spot' },
                    { id: '2-6', date: '2026-02-12', time: '14:00', title: 'ËÅñÂ¨∞Â§ßÊïôÂ†Ç', locationName: 'Basilica del Santo Ni√±o', type: 'spot' },
                    { id: '2-7', date: '2026-02-12', time: '15:00', title: 'ËÅñ‰Ω©Âæ∑ÁæÖÂ†°', locationName: 'Fort San Pedro', type: 'spot' },
                    { id: '2-8', date: '2026-02-12', time: '18:00', title: 'ÊôöÈ§ê (Texas Roadhouse)', locationName: 'SM Seaside', type: 'food', tag: 'Êé®Ëñ¶' },

                    // Day 3: 2/13
                    { id: '3-0', date: '2026-02-13', time: '07:30', title: 'È£ØÂ∫óÊó©È§ê', locationName: 'Parklane Hotel', type: 'food' },
                    { id: '3-1', date: '2026-02-13', time: '10:40', title: 'ÊäµÈÅîÊ∏ØÂè£ Pier 1', locationName: 'Cebu Pier 1', type: 'note', tag: 'Ë≤∑ÂçàÈ§ê' },
                    { id: '3-2', date: '2026-02-13', time: '11:40', title: 'Êê≠Ëàπ Ocean Jet', locationName: 'ÂâçÂæÄËñÑËç∑Â≥∂', type: 'transport', tag: 'KKDayÁ•®' },
                    { id: '3-3', date: '2026-02-13', time: '14:00', title: 'ÊäµÈÅî Tagbilaran', locationName: 'Bohol', type: 'transport', tag: 'ÂåÖËªä1200p' },
                    { id: '3-4', date: '2026-02-13', time: '15:00', title: 'È£ØÂ∫ó Check-in', locationName: 'Best Western Plus (Alona)', type: 'hotel' },
                    { id: '3-5', date: '2026-02-13', time: '16:00', title: 'Â∫¶ÂÅáÊùëÁé©', locationName: 'Swimming Pool', type: 'activity' },
                    { id: '3-6', date: '2026-02-13', time: '18:00', title: 'Êµ∑ÁÅòÂ§úÂ∏ÇÊàñÈôÑËøëÈ§êÂª≥', locationName: 'Giuseppe Pizzeria', type: 'food', tag: 'Êé®Ëñ¶' },

                    // Day 4: 2/14
                    { id: '4-0', date: '2026-02-14', time: '07:30', title: 'È£ØÂ∫óÊó©È§ê', locationName: 'Best Western', type: 'food' },
                    { id: '4-1', date: '2026-02-14', time: '09:00', title: 'Napaling Reef', locationName: 'Ê≤ô‰∏ÅÈ≠öÊµÆÊΩõ', type: 'spot' },
                    { id: '4-2', date: '2026-02-14', time: '11:00', title: 'Hinagdanan Cave', locationName: 'No Swim', type: 'spot' },
                    { id: '4-3', date: '2026-02-14', time: '12:00', title: 'ÂçàÈ§ê: Ubeco Restaurant', locationName: 'ÈüìÁ≥ªÁ∂≤ÁæéÂ∫ó', type: 'food', tag: 'ÊåáÂÆö' },
                    { id: '4-4', date: '2026-02-14', time: '14:00', title: 'Â∫¶ÂÅáÊùëÁé©', locationName: 'Best Western', type: 'activity' },
                    { id: '4-5', date: '2026-02-14', time: '18:00', title: 'Êµ∑ÁÅòÂ§úÂ∏ÇÊàñÈôÑËøëÈ§êÂª≥', locationName: 'Mist', type: 'food', tag: 'Êé®Ëñ¶' },

                    // Day 5: 2/15
                    { id: '5-0', date: '2026-02-15', time: '05:30', title: 'È£ØÂ∫óÊó©È§ê', locationName: 'Best Western', type: 'food', tag: 'Êó©Ëµ∑' },
                    { id: '5-1', date: '2026-02-15', time: '06:00', title: 'Ë∑≥Â≥∂‰∏ÄÊó•ÈÅä', locationName: 'Balicasag (Êµ∑Èæú)', type: 'spot', tag: 'ÂåÖËàπ1500p' },
                    { id: '5-2', date: '2026-02-15', time: '11:00', title: 'Virgin Island', locationName: 'ËôïÂ•≥Â≥∂', type: 'spot' },
                    { id: '5-3', date: '2026-02-15', time: '14:00', title: 'Back to villa (ÊãøË°åÊùé)', locationName: 'Check-out', type: 'transport' },
                    { id: '5-4', date: '2026-02-15', time: '14:30', title: 'Check in Villa Kalachuchi', locationName: 'Danao ÂçÄ', type: 'hotel' },
                    { id: '5-5', date: '2026-02-15', time: '18:00', title: 'Êµ∑ÁÅòÂ§úÂ∏ÇÊàñÈôÑËøëÈ§êÂª≥', locationName: 'Luna Rossa', type: 'food', tag: 'Êé®Ëñ¶' },

                    // Day 6: 2/16
                    { id: '6-0', date: '2026-02-16', time: '08:00', title: 'ÁÑ°Êó©È§êÊúâÂªöÊàø', locationName: 'Villa Kalachuchi', type: 'note' },
                    { id: '6-1', date: '2026-02-16', time: '09:00', title: 'ÂåÖËªä‰∏ÄÊó•ÈÅä (6500p)', locationName: 'Bohol ÂÖßÈô∏', type: 'transport' },
                    { id: '6-2', date: '2026-02-16', time: '10:00', title: '‰∫∫ÈÄ†Ê£ÆÊûó & ÁúºÈè°Áå¥', locationName: 'Bilar / Tarsier', type: 'spot' },
                    { id: '6-3', date: '2026-02-16', time: '12:00', title: 'Lunch (Rio Verde Floating)', locationName: 'ÊºÇÊµÅÁ´πÁ≠è', type: 'food' },
                    { id: '6-4', date: '2026-02-16', time: '14:00', title: 'Â∑ßÂÖãÂäõÂ±±', locationName: 'Chocolate Hills', type: 'spot' },
                    { id: '6-5', date: '2026-02-16', time: '15:30', title: 'Áé©ÊªëÁ¥¢ÂèäÁ∫úËªä (Loboc)', locationName: 'Ecotourism Park', type: 'spot' },
                    { id: '6-6', date: '2026-02-16', time: '16:30', title: 'Graham ATV Rental', locationName: 'ATV', type: 'spot' },
                    { id: '6-7', date: '2026-02-16', time: '17:00', title: 'Back to villa', locationName: 'Villa Kalachuchi', type: 'transport' },
                    { id: '6-8', date: '2026-02-16', time: '18:00', title: 'Êµ∑ÁÅòÂ§úÂ∏ÇÊàñÈôÑËøëÈ§êÂª≥', locationName: 'Bohol Bee Farm', type: 'food', tag: 'Êé®Ëñ¶' },

                    // Day 7: 2/17
                    { id: '7-0', date: '2026-02-17', time: '08:00', title: 'ÁÑ°Êó©È§êÊúâÂªöÊàø', locationName: 'Villa Kalachuchi', type: 'note' },
                    { id: '7-1', date: '2026-02-17', time: '11:00', title: 'Check-out & South Farm', locationName: 'ÂãïÁâ©Ëæ≤Â†¥ÂçàÈ§ê', type: 'spot' },
                    { id: '7-2', date: '2026-02-17', time: '12:00', title: 'È§µÂãïÁâ©È®éÈ¶¨', locationName: 'South Farm', type: 'activity' },
                    { id: '7-3', date: '2026-02-17', time: '14:30', title: 'Back to villa (ÊãøË°åÊùé)', locationName: 'Villa Kalachuchi', type: 'transport' },
                    { id: '7-4', date: '2026-02-17', time: '15:30', title: 'ÂâçÂæÄÈÇ¶ÂãûÊ©üÂ†¥', locationName: 'Panglao Airport', type: 'transport' },
                    { id: '7-5', date: '2026-02-17', time: '18:20', title: '5J616 È£õÂæÄÈ¶¨Â∞ºÊãâ', locationName: 'TAG -> MNL', type: 'transport' },
                    { id: '7-6', date: '2026-02-17', time: '20:00', title: 'ÊäµÈÅîÈ¶¨Â∞ºÊãâ (Grab Car)', locationName: 'MNL T3', type: 'transport', tag: 'ÂãøÈÅ∏Taxi' },
                    { id: '7-7', date: '2026-02-17', time: '21:00', title: 'È£ØÂ∫ó Checkin', locationName: 'Uptown Parksuites Tower 2', type: 'hotel' },
                    { id: '7-8', date: '2026-02-17', time: '21:30', title: 'ÊôöÈ§ê', locationName: 'Shake Shack', type: 'food', tag: 'Êé®Ëñ¶' },

                    // Day 8: 2/18
                    { id: '8-0', date: '2026-02-18', time: '09:00', title: 'ÁÑ°Êó©È§êÊúâÂªöÊàø', locationName: 'Wildflour Cafe', type: 'food', tag: 'Êé®Ëñ¶' },
                    { id: '8-1', date: '2026-02-18', time: '10:00', title: 'ÈÄõÂ∏ÇÂçÄÊôØÈªû', locationName: 'BGC', type: 'activity' },
                    { id: '8-2', date: '2026-02-18', time: '11:00', title: 'Mind Museum', locationName: 'Jose Yao Campos Park', type: 'spot' },
                    { id: '8-3', date: '2026-02-18', time: '12:00', title: 'ÂçàÈ§ê', locationName: 'Mamou Meats', type: 'food', tag: 'Êé®Ëñ¶' },
                    { id: '8-4', date: '2026-02-18', time: '18:00', title: 'ÊôöÈ§ê', locationName: 'George and Onnie\'s', type: 'food', tag: 'Êé®Ëñ¶' },
                    { id: '8-5', date: '2026-02-18', time: '19:00', title: 'Êê≠È£õÊ©ü Check-in', locationName: 'MNL T3', type: 'transport' },
                    { id: '8-6', date: '2026-02-18', time: '23:35', title: '5J310 ËøîÂè∞', locationName: 'MNL -> TPE', type: 'transport' }
                ];

                const tabs = [{ id: 'schedule', label: 'Ë°åÁ®ã', icon: 'calendar' }, { id: 'map', label: 'Âú∞Âúñ', icon: 'map' }];
                
                const tripDays = [
                    { date: '2026-02-11', dateShort: '2/11', dayShort: 'Wed', dayName:'ÈÄ±‰∏â', dayNum: '11' }, 
                    { date: '2026-02-12', dateShort: '2/12', dayShort: 'Thu', dayName:'ÈÄ±Âõõ', dayNum: '12' },
                    { date: '2026-02-13', dateShort: '2/13', dayShort: 'Fri', dayName:'ÈÄ±‰∫î', dayNum: '13' }, 
                    { date: '2026-02-14', dateShort: '2/14', dayShort: 'Sat', dayName:'ÈÄ±ÂÖ≠', dayNum: '14' },
                    { date: '2026-02-15', dateShort: '2/15', dayShort: 'Sun', dayName:'ÈÄ±Êó•', dayNum: '15' }, 
                    { date: '2026-02-16', dateShort: '2/16', dayShort: 'Mon', dayName:'ÈÄ±‰∏Ä', dayNum: '16' },
                    { date: '2026-02-17', dateShort: '2/17', dayShort: 'Tue', dayName:'ÈÄ±‰∫å', dayNum: '17' }, 
                    { date: '2026-02-18', dateShort: '2/18', dayShort: 'Wed', dayName:'ÈÄ±‰∏â', dayNum: '18' }
                ];

                const currentTab = ref('schedule');
                const showEventModal = ref(false);
                const itinerary = ref([]);

                // È†êË®≠Êó•ÊúüÁÇ∫Á¨¨‰∏ÄÂ§©
                const formEvent = ref({ 
                    date: '2026-02-11', 
                    time: '12:00', 
                    title: '', 
                    locationName: '', 
                    type: 'food', 
                    tag: '', 
                    lat: null, 
                    lng: null 
                });

                let map = null, markersLayer = null, pathLayer = null;

                const initFirebaseListeners = async () => {
                    const { collection, onSnapshot, query, orderBy, addDoc, getDocs } = fireOps.value;
                    const db = dbInstance.value;

                    // ‰ΩøÁî®Êñ∞ÁöÑÈõÜÂêàÂêçÁ®±‰ª•Á¢∫‰øùË≥áÊñôÈáçÊñ∞ÂØ´ÂÖ• (V2)
                    const collectionName = "remi_trip_2026_final_v2";
                    const evColl = collection(db, collectionName);
                    
                    try {
                        const snapshotCheck = await getDocs(evColl);
                        if (snapshotCheck.empty) {
                            console.log("Empty DB, populating initial itinerary...");
                            // ÊâπÊ¨°ÂØ´ÂÖ•Ë≥áÊñô
                            const promises = initialItinerary.map(item => addDoc(evColl, item));
                            await Promise.all(promises);
                            console.log("Data populated!");
                        }
                    } catch (e) {
                        console.error("Error populating data:", e);
                    }

                    // Listen to Itinerary
                    const qItinerary = query(collection(db, collectionName)); 
                    onSnapshot(qItinerary, (snapshot) => {
                        itinerary.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        fetchWeather(); 
                        if (currentTab.value === 'map') updateMapMarkers();
                    });
                };
                
                const forceInit = async () => {
                    window.location.reload();
                };

                const saveEvent = async () => {
                    const { addDoc, collection } = fireOps.value;
                    const collectionName = "remi_trip_2026_final_v2";
                    await addDoc(collection(dbInstance.value, collectionName), {
                        ...formEvent.value,
                        weather: null,
                        createdAt: new Date()
                    });
                    showEventModal.value = false;
                };

                const deleteEvent = async (id) => {
                    if(!confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) return;
                    const { deleteDoc, doc } = fireOps.value;
                    const collectionName = "remi_trip_2026_final_v2";
                    await deleteDoc(doc(dbInstance.value, collectionName, id));
                };

                const scrollToDay = (date) => {
                    const el = document.getElementById('day-' + date);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };

                const switchTab = (tabId) => {
                    currentTab.value = tabId;
                    if(tabId === 'map') nextTick(() => { if(!map) initMap(); else { map.invalidateSize(); updateMapMarkers(); } });
                };
                const openMapForEvent = (event) => { switchTab('map'); setTimeout(() => { if(event.lat) { map.setView([event.lat, event.lng], 16); L.popup().setLatLng([event.lat, event.lng]).setContent(event.title).openOn(map); } }, 500); };

                // --- Helper Functions ---
                const getEventsForDay = (date) => {
                    return itinerary.value
                        .filter(e => e.date === date)
                        .sort((a, b) => a.time.localeCompare(b.time));
                };

                // (Standard helpers: getWeatherIcon, getTypeName, etc. same as before)
                const getWeatherIcon = (code) => code <= 3 ? 'sun' : 'cloud';
                const getTypeName = (type) => ({'food':'È§êÂª≥', 'spot':'ÊôØÈªû', 'transport':'‰∫§ÈÄö', 'hotel':'‰ΩèÂÆø', 'note':'Á≠ÜË®ò', 'activity':'Ê¥ªÂãï', 'meal':'È§êÈ£≤'})[type] || 'ÂÖ∂‰ªñ';
                const getTypeStyle = (type) => {
                    if(type==='food' || type==='meal') return 'bg-orange-50 text-orange-600 border-orange-100';
                    if(type==='transport') return 'bg-blue-50 text-blue-600 border-blue-100';
                    if(type==='hotel') return 'bg-indigo-50 text-indigo-600 border-indigo-100';
                    if(type==='note') return 'bg-red-50 text-red-600 border-red-100';
                    return 'bg-teal-50 text-teal-600 border-teal-100';
                };
                const getTypeColor = (type) => {
                    if(type==='food' || type==='meal') return 'bg-orange-400';
                    if(type==='transport') return 'bg-blue-400';
                    if(type==='hotel') return 'bg-indigo-400';
                    if(type==='note') return 'bg-red-400';
                    return 'bg-teal-400';
                };
                
                // (Map logic same as before)
                const initMap = () => {
                    if (map) return;
                    map = L.map('map-container', { zoomControl: false }).setView([10.3157, 123.8854], 12);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                    markersLayer = L.layerGroup().addTo(map);
                    updateMapMarkers();
                };
                const updateMapMarkers = () => {
                    if (!map || !markersLayer) return;
                    markersLayer.clearLayers();
                    // Show markers for all days or current day? Let's show all for overview
                    const events = itinerary.value.filter(e => e.lat && e.lng);
                    const latlngs = [];
                    events.forEach((e, idx) => {
                        const point = [e.lat, e.lng];
                        latlngs.push(point);
                        const icon = L.divIcon({ className: 'custom-div-icon', html: idx + 1, iconSize: [24, 24] });
                        L.marker(point, { icon }).bindPopup(e.title).addTo(markersLayer);
                    });
                    if (latlngs.length > 0) {
                        const bounds = L.latLngBounds(latlngs);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                };
                const locateUser = () => { if(map) map.locate({ setView: true, maxZoom: 14 }); };
                const fitBounds = () => updateMapMarkers();
                const fetchWeather = async () => {}; // simplified for now

                // Init
                window.addEventListener('firebase-ready', () => {
                    dbInstance.value = window.db;
                    fireOps.value = window.firestoreOps;
                    initFirebaseListeners();
                    firebaseReady.value = true;
                });

                onMounted(() => { lucide.createIcons(); });
                watch([currentTab, itinerary], () => nextTick(() => lucide.createIcons()));

                return {
                    firebaseReady, tabs, currentTab, switchTab, tripDays, 
                    itinerary, getEventsForDay, scrollToDay,
                    showEventModal, formEvent,
                    saveEvent, deleteEvent, forceInit,
                    getWeatherIcon, getTypeName, getTypeStyle, getTypeColor, openMapForEvent, locateUser, fitBounds
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
